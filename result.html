<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HanName ‚Äî Your Chinese Name Certificate</title>
  <meta name="description" content="A bilingual, culturally-rich Chinese name certificate with pronunciation, literature sources, five-element analysis, and zodiac insights." />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Noto+Serif+TC:wght@400;500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <base href="https://joy-trycoding.github.io/hanname2/">

  <style>
/* ===== Loading overlay ===== */
.loading-overlay{
  position: fixed; inset: 0; background: rgba(245,241,232,0.9);
  display:flex; align-items:center; justify-content:center;
  z-index:9999; transition: opacity .6s ease, visibility .6s ease;
  overflow:hidden;
}
.loading-overlay.hide{ opacity:0; visibility:hidden; }
.loading-msg{
  position: relative; z-index:2;
  font-family:'Noto Serif TC','Playfair Display',serif;
  font-size:22px; color:#444; letter-spacing:.06em;
  background: rgba(255,255,255,0.6);
  padding:10px 16px; border-radius:8px; border:1px solid #e7e0d2;
  box-shadow: 0 6px 30px rgba(0,0,0,.05);
}
.floating-zh{ position:absolute; inset:0; overflow:hidden; z-index:1; pointer-events:none; }
.floating-zh span{
  position:absolute; font-family:'Noto Serif TC','Playfair Display',serif;
  font-size: clamp(18px, 3vw, 32px); color:#000; opacity:.06; white-space:nowrap; user-select:none;
  animation: floatUp 6s linear infinite;
}
@keyframes floatUp{
  0%{ transform: translateY(20px); opacity:0.02; }
  10%{ opacity:.08; }
  90%{ opacity:.08; }
  100%{ transform: translateY(-40px); opacity:0; }
}

/* ===== Theme & layout ===== */
:root{ --paper:#F5F1E8; --ink:#1C1B1A; --accent:#C49A6C; --muted:#666; --line:#E5DFD3; }
*{box-sizing:border-box}
body{margin:0; background:var(--paper); color:var(--ink); font-family:'Inter','Noto Serif TC',serif; line-height:1.65}
a{color:inherit}
.header{display:flex; align-items:center; gap:10px; padding:10px 16px}
.header .brand img{height:32px}
.wrap{max-width:980px; margin:0 auto; padding:16px}

/* Certificate card */
.certificate{background:#fff; border:8px double var(--line); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.06); padding:24px;}
.title{font-family:'Playfair Display','Noto Serif TC',serif; text-align:center; font-size:28px; margin:6px 0 2px}
.subtitle{text-align:center; color:#444; font-size:13px; margin:0 0 10px}
.divider{height:2px; background:var(--line); margin:12px 0 18px}

/* Name block */
.name-block{display:grid; gap:4px; justify-items:center; margin:8px 0 16px}
.cn-name{font-family:'Noto Serif TC','Playfair Display',serif; font-size:46px; font-weight:700; letter-spacing:.06em}
.pinyin{font-size:16px; color:var(--accent)}
.btn{appearance:none; border:1px solid var(--ink); background:var(--ink); color:#fff; padding:8px 14px; border-radius:999px; cursor:pointer}
.btn:hover{opacity:.92}
.btn-ghost{background:#fff; color:var(--ink); border:1px solid var(--ink)}

/* Info grid */
.grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
.panel{border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff}
.panel h3{font-family:'Playfair Display','Noto Serif TC',serif; font-size:18px; margin:0 0 8px}
.panel p{margin:6px 0}
.em{color:#222; font-weight:600}
.zh{font-family:'Noto Serif TC','Playfair Display',serif}

/* Story block */
.story{margin-top:10px; padding-top:10px; border-top:1px dashed var(--line)}
.story h4{margin:0 0 6px; font-size:15px; color:#333}
.story p{margin:6px 0}

/* Actions */
.actions{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px}
.share-wrap{position:relative; display:inline-flex}
.share-pop{position:absolute; top:calc(100% + 8px); right:0; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:8px; display:none; min-width:220px; z-index:50}
.share-pop.open{display:block}
.share-pop .row{display:flex; gap:8px; flex-wrap:wrap; padding:6px}
.share-pop .hint{font-size:12px; color:#555; padding:6px 8px 2px}

/* Gift gallery */
.gifts{margin-top:22px}
.gifts h3{font-family:'Playfair Display','Noto Serif TC',serif; font-size:20px; margin:6px 0 10px; text-align:center}
.gift-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
.gift{background:#fff; border:1px solid var(--line); border-radius:14px; overflow:hidden; display:flex; flex-direction:column}
.gift img{width:100%; height:auto; display:block}
.gift-body{padding:12px}
.gift h4{margin:0 0 6px; font-size:16px}
.gift p{margin:0 0 10px; color:#333; font-size:14px}
.gift .row{display:flex; gap:8px; flex-wrap:wrap}

/* Footer note */
.footnote{margin-top:12px; font-size:12px; color:#666; text-align:center}

/* RWD */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
  .cn-name{font-size:40px}
  .gift-grid{grid-template-columns:1fr}
}
  </style>
</head>
<body>
  <header class="header">
    <a class="brand" href="index.html" aria-label="Back to HanName home">
      <img src="assets/logo.jpg" alt="HanName logo" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'HanName',style:'font-weight:700;font-family:Playfair Display, Noto Serif TC, serif;font-size:18px;' }))" />
    </a>
  </header>

  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <!-- ‚ë† Ëã±ÊñáÂåñ -->
    <div class="loading-msg">Designing your name‚Ä¶</div>
    <div id="floatingZh" class="floating-zh"></div>
  </div>

  <main class="wrap">
    <section id="cert" class="certificate">
      <h1 class="title">Chinese Name Certificate</h1>
      <p class="subtitle">A personalized cultural identity crafted from sound, meaning, literature, Five Elements, and zodiac.</p>
      <div class="divider"></div>

      <div class="name-block">
        <div id="enName" class="en-name" style="font-size:14px; color:#555">English Name: ‚Äî</div>
        <div id="cnFullName" class="cn-name">‚Äî</div>
        <div class="pinyin"><span id="pinyinFull">‚Äî</span> <button id="speak" class="btn" data-track="play-tts" title="Hear pronunciation">üîä</button></div>
        <div id="tagline" style="font-size:14px; color:#333"></div>
      </div>

      <div class="grid">
        <article class="panel" id="surnamePanel">
          <h3>Surname ¬∑ ÂßìÊ∞è</h3>
          <p id="surnameLine"></p>
          <p id="surnameOrigin"></p>
        </article>

        <article class="panel" id="givenPanel">
          <h3>Given Name ¬∑ ÂêçÂ≠ó</h3>
          <p id="givenLine"></p>

          <!-- Cultural story -->
          <div class="story">
            <h4>Story ¬∑ ÂêçÂ≠óÁöÑÊïÖ‰∫ã</h4>
            <p id="storyEn"></p>
            <p id="storyZh" class="zh"></p>
          </div>

          <div class="analysis">
            <p id="classicEn"></p>
            <p id="classicZh" class="zh"></p>
            <p id="fiveElEn"></p>
            <p id="fiveElZh" class="zh"></p>
            <p id="zodiacEn"></p>
            <p id="zodiacZh" class="zh"></p>
          </div>
        </article>
      </div>

      <!-- Actions -->
      <div class="actions" aria-label="actions">
        <button id="download" class="btn" data-track="download-cert">Download Certificate</button>
        <a id="gift" class="btn btn-ghost" href="gift.html" data-track="seal-gift">Create Your Seal Gift</a>

        <!-- ‚ë° ÂñÆ‰∏Ä Share ÊåâÈàï + Popover ÈÅ∏Êìá -->
        <div class="share-wrap">
          <button id="shareMain" class="btn" title="Share your name">Share</button>
          <div id="sharePop" class="share-pop" role="menu" aria-hidden="true">
            <div class="hint">Choose a platform</div>
            <div class="row">
              <button id="shareX" class="btn">X (Twitter)</button>
              <button id="shareThreads" class="btn btn-ghost">Threads</button>
              <button id="shareIG" class="btn btn-ghost">Instagram</button>
            </div>
          </div>
        </div>
      </div>

      <p class="footnote">Tip: Save this certificate as a PDF or print it.</p>

      <!-- ‚ë¢ Gifts: Ëã±ÊñáÊ®ôÈ°å/Ë™™Êòé + ÂúñÁâá + Ëã±ÊñáÊåâÈàï -->
      <div class="gifts" id="giftShowcase">
        <h3>Bring Your Name to Life</h3>
        <div class="gift-grid">
          <article class="gift">
            <img src="assets/gifts/calligraphy-scroll.jpg" alt="Handwritten calligraphy scroll by respected elder" loading="lazy" onerror="this.src='assets/gifts/wood-seal.jpg'">
            <div class="gift-body">
              <h4>Elder‚Äôs Handwritten Calligraphy Scroll</h4>
              <p>Your Chinese name is handwritten with a brush by a respected elder ‚Äî a keepsake carrying blessings and care.</p>
              <div class="row">
                <a class="btn btn-ghost" href="gift.html#handwritten">Learn more</a>
                <a class="btn" href="gift.html#handwritten">Shop now</a>
              </div>
            </div>
          </article>

          <article class="gift">
            <img src="assets/gifts/wood-seal.jpg" alt="Custom wooden or horn name seal" loading="lazy">
            <div class="gift-body">
              <h4>Custom Name Seal (Wood or Horn)</h4>
              <p>Engraved with your name ‚Äî optionally with a classical source ‚Äî practical, meaningful, and beautifully traditional.</p>
              <div class="row">
                <a class="btn btn-ghost" href="gift.html#seal">Learn more</a>
                <a class="btn" href="gift.html#seal">Shop now</a>
              </div>
            </div>
          </article>

          <article class="gift">
            <img src="assets/gifts/gift-box.jpg" alt="Premium gift box with certificate and seal" loading="lazy" onerror="this.src='assets/gifts/horn-seal.jpg'">
            <div class="gift-body">
              <h4>Premium Gift Box (Certificate + Seal)</h4>
              <p>A complete set that pairs your bilingual certificate with a custom seal and story card ‚Äî perfect for gifting.</p>
              <div class="row">
                <a class="btn btn-ghost" href="gift.html#box">Learn more</a>
                <a class="btn" href="gift.html#box">Shop now</a>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    (async function init(){
      /* ===== Config & helpers ===== */
      const ROOT = "/hanname2";
      const PATH = {
        surnames: `${ROOT}/data/surnames.json?v=fix2`,
        classics: `${ROOT}/data/classics.json?v=fix2`,
        // ÂèØÊó•ÂæåÊñ∞Â¢ûÔºögivens: `${ROOT}/data/givenNameData.json?v=fix2`
      };
    
      const $ = (id)=>document.getElementById(id);
      const hash2 = (s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h|0; };
      const pickIndex = (n, seedStr)=> (n? Math.abs(hash2(seedStr))%n : -1);
      async function loadJSON(url){ const res=await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); }
    
      /* ===== Five elements & zodiac ===== */
      const MONTH_TO_ELEMENT = {1:'Water',2:'Wood',3:'Wood',4:'Wood',5:'Fire',6:'Fire',7:'Fire',8:'Earth',9:'Metal',10:'Metal',11:'Water',12:'Water'};
      const ELEMENT_ZH = {Wood:'Êú®', Fire:'ÁÅ´', Earth:'Âúü', Metal:'Èáë', Water:'Ê∞¥'};
      function zodiac(m,d){
        const z=[['Capricorn',1,19],['Aquarius',2,18],['Pisces',3,20],['Aries',4,19],['Taurus',5,20],['Gemini',6,20],['Cancer',7,22],['Leo',8,22],['Virgo',9,22],['Libra',10,22],['Scorpio',11,21],['Sagittarius',12,21],['Capricorn',12,31]];
        for(const [name,mm,dd] of z){ if(m<mm || (m===mm && d<=dd)) return name; }
      }
      const ZODIAC_CN_MAP = {
        Pisces:{cn:'ÈõôÈ≠ö', traitEn:'sensitive and insightful', traitZh:'ÊÑüÊÄßËÄåÂÖ∑Ê¥ûÂØüÂäõ'},
        Aries:{cn:'Áâ°Áæä', traitEn:'decisive and pioneering', traitZh:'ÊûúÊï¢ÈñãÂâµ'},
        Taurus:{cn:'ÈáëÁâõ', traitEn:'grounded and persevering', traitZh:'Ë∏èÂØ¶Â†ÖÂÆö'},
        Gemini:{cn:'ÈõôÂ≠ê', traitEn:'curious and expressive', traitZh:'Â•ΩÂ•áÂñÑË®Ä'},
        Cancer:{cn:'Â∑®Ëüπ', traitEn:'nurturing and protective', traitZh:'ÈóúÊá∑ÂÆàË≠∑'},
        Leo:{cn:'ÁçÖÂ≠ê', traitEn:'radiant and confident', traitZh:'Ëá™‰ø°ÈñÉËÄÄ'},
        Virgo:{cn:'ËôïÂ•≥', traitEn:'refined and meticulous', traitZh:'Á¥∞ËÜ©Ë¨õÁ©∂'},
        Libra:{cn:'Â§©Áß§', traitEn:'balanced and graceful', traitZh:'Âπ≥Ë°°ÂÑ™ÈõÖ'},
        Scorpio:{cn:'Â§©Ë†ç', traitEn:'deep and resolute', traitZh:'Ê∑±Ê≤âÊûúÊ±∫'},
        Sagittarius:{cn:'Â∞ÑÊâã', traitEn:'far-sighted and free', traitZh:'ÈÅ†ÂøóËá™Áî±'},
        Capricorn:{cn:'Êë©ÁæØ', traitEn:'enduring and disciplined', traitZh:'ÈüåÊÄßËá™Âæã'},
        Aquarius:{cn:'Ê∞¥Áì∂', traitEn:'original and humane', traitZh:'ÂâµÊñ∞ÂçöÊÑõ'}
      };
    
      /* ===== Minimal given-name fallback pool ===== */
      const FALLBACK_POOL = {
        Wood:{
          female:[{cn:'ÈõÖÂØß',py:'Y«én√≠ng',gender:'female',classicChar:'ÈõÖ',classicSourceEn:'Shijing ¬∑ Da Ya',classicSourceZh:'„ÄäË©©Á∂ì¬∑Â§ßÈõÖ„Äã',quoteEn:'Da Ya',quoteZh:'Â§ßÈõÖ',meaningEn:'elegance & serenity',meaningZh:'ÂÑ™ÈõÖËàáÂÆâÂØß'}],
          male:[{cn:'ÂçöÈÅ†',py:'B√≥yu«én',gender:'male',classicChar:'ÈÅ†',classicSourceEn:'Qu Yuan ¬∑ Lisao',classicSourceZh:'Â±àÂéü¬∑Èõ¢È®∑',quoteEn:'The road ahead is long',quoteZh:'Ë∑ØÊº´Êº´ÂÖ∂‰øÆÈÅ†ÂÖÆ',meaningEn:'breadth and vision',meaningZh:'ËÉ∏Ë•üËàáÂÆèÈÅ†'}],
          neutral:[{cn:'Ê∏ÖÈõ≤',py:'Qƒ´ngy√∫n',gender:'neutral',classicChar:'Èõ≤',classicSourceEn:'Tang Poetry imagery',classicSourceZh:'ÂîêË©©ÊÑèË±°',quoteEn:'Clouds travel free',quoteZh:'Èõ≤ÁÑ°ÂøÉ‰ª•Âá∫Â≤´',meaningEn:'clarity and freedom',meaningZh:'Ê∏ÖÊæàËá™Áî±'}]
        },
        Fire:{
          female:[{cn:'ÊõâÊÅ©',py:'Xi«éoƒìn',gender:'female',classicChar:'Êõâ',classicSourceEn:'Song Ci',classicSourceZh:'ÂÆãË©û',quoteEn:'Dawn breeze and waning moon',quoteZh:'ÊõâÈ¢®ÊÆòÊúà',meaningEn:'gentle warmth',meaningZh:'Ê∫´ÊüîÊô®ÂÖâ'}],
          male:[{cn:'ÊñáËªí',py:'W√©nxuƒÅn',gender:'male',classicChar:'Êñá',classicSourceEn:'Analects',classicSourceZh:'„ÄäË´ñË™û„Äã',quoteEn:'Be never weary of learning',quoteZh:'Â≠∏ËÄå‰∏çÂé≠',meaningEn:'cultured and bright',meaningZh:'ÊñáÈõÖÊòéÊúó'}],
          neutral:[{cn:'ÊõúÂíå',py:'Y√†oh√©',gender:'neutral',classicChar:'Êõú',classicSourceEn:'Shijing imagery',classicSourceZh:'„ÄäË©©Á∂ì„ÄãÊÑèË±°',quoteEn:'Radiant light',quoteZh:'ÂÖâÊõúÂÖ∂ËèØ',meaningEn:'radiant & harmonious',meaningZh:'ÊòéÈ∫óËÄå‰∏≠Âíå'}]
        },
        Earth:{
          female:[{cn:'ÈùúÁë§',py:'J√¨ngy√°o',gender:'female',classicChar:'Áë§',classicSourceEn:'Tang poetry',classicSourceZh:'ÂîêË©©',quoteEn:'Jade terrace and moon',quoteZh:'Áë§Âè∞Êúà‰∏ã',meaningEn:'quiet radiance',meaningZh:'Èùú‰∏≠ÁîüÂÖâ'}],
          male:[{cn:'ÂøóÂÆè',py:'Zh√¨h√≥ng',gender:'male',classicChar:'Âøó',classicSourceEn:'Mencius',classicSourceZh:'„ÄäÂ≠üÂ≠ê„Äã',quoteEn:'Will on the Way',quoteZh:'ÂøóÊñºÈÅìÔºåÊìöÊñºÂæ∑',meaningEn:'great aspiration',meaningZh:'ÂÆèÈÅ†‰πãÂøó'}],
          neutral:[{cn:'Ë°°ÈÄ∏',py:'H√©ngy√¨',gender:'neutral',classicChar:'Ë°°',classicSourceEn:'Doctrine of the Mean',classicSourceZh:'„Ää‰∏≠Â∫∏„Äã',quoteEn:'Holding the balance',quoteZh:'Âü∑ÂÖ∂‰∏≠',meaningEn:'balance & ease',meaningZh:'‰∏≠ÂíåËàáÁÅëËÑ´'}]
        },
        Metal:{
          female:[{cn:'ÊôØË®Ä',py:'J«êngy√°n',gender:'female',classicChar:'Ë®Ä',classicSourceEn:'Analects',classicSourceZh:'„ÄäË´ñË™û„Äã',quoteEn:'Words reflect the heart',quoteZh:'Ë®ÄÁÇ∫ÂøÉËÅ≤',meaningEn:'clear expression',meaningZh:'Ê∏ÖÊúó‰πãË®Ä'}],
          male:[{cn:'ÂÆáËæ∞',py:'Y«îch√©n',gender:'male',classicChar:'Ëæ∞',classicSourceEn:'Song Ci',classicSourceZh:'ÂÆãË©û',quoteEn:'Fine time & scene',quoteZh:'ËâØËæ∞ÁæéÊôØ',meaningEn:'cosmic poise',meaningZh:'ÂÆáÈáèËàáÊôÇËæ∞'}],
          neutral:[{cn:'Ê≠£ÁÑ∂',py:'Zh√®ngr√°n',gender:'neutral',classicChar:'Ê≠£',classicSourceEn:'Great Learning',classicSourceZh:'„ÄäÂ§ßÂ≠∏„Äã',quoteEn:'Rectify the mind',quoteZh:'Ê≠£ÂøÉË™†ÊÑè',meaningEn:'upright & natural',meaningZh:'Á´ØÊ≠£Ëá™ÁÑ∂'}]
        },
        Water:{
          female:[{cn:'ÂøÉÂ¶Ç',py:'Xƒ´nr√∫',gender:'female',classicChar:'ÂøÉ',classicSourceEn:'Literary aphorism',classicSourceZh:'Êñá‰∫∫Ë™û',quoteEn:'Heart like water',quoteZh:'‰∏ÄÂøÉÂ¶ÇÊ∞¥',meaningEn:'pure-hearted',meaningZh:'ÂøÉÊæÑÂ¶ÇÊ∞¥'}],
          male:[{cn:'Ê∏ÖÊüè',py:'Qƒ´ngb«éi',gender:'male',classicChar:'Êüè',classicSourceEn:'Analects',classicSourceZh:'„ÄäË´ñË™û„Äã',quoteEn:'Pine & cypress endure',quoteZh:'Ê≠≤ÂØíÁÑ∂ÂæåÁü•ÊùæÊüè‰πãÂæåÂáã‰πü',meaningEn:'clarity & integrity',meaningZh:'Ê∏ÖÊ≠£ËàáÁØÄÊìç'}],
          neutral:[{cn:'Ê∂µÁÜô',py:'H√°nxƒ´',gender:'neutral',classicChar:'Ê∂µ',classicSourceEn:'Wenxin Diaolong',classicSourceZh:'„ÄäÊñáÂøÉÈõïÈæç„Äã',quoteEn:'Immerse in patterns',quoteZh:'Ê∂µÊ≥≥ÊñáÁêÜ',meaningEn:'inclusive & warm',meaningZh:'ÂåÖÊ∂µÊ∫´Âíå'}]
        }
      };
    
      /* ===== Query & demo ===== */
      const qs = new URLSearchParams(location.search);
      let enName = (qs.get('name') || '').trim();
      let gender = (qs.get('gender') || '').toLowerCase();
      const birth = qs.get('birth') || '';
    
      const DEMO = [
        {en:'Emily Smith', gender:'female', birth:'1994-03-02'},
        {en:'Daniel Lee', gender:'male',   birth:'1992-07-15'},
        {en:'Sophia Chen', gender:'female',birth:'1996-06-28'}
      ];
      if(!enName){
        const demo = DEMO[Math.floor(Math.random()*DEMO.length)];
        enName = demo.en;
        if(!qs.get('gender')) gender = demo.gender;
        if(!qs.get('birth')){
          location.search = `?name=${encodeURIComponent(enName)}&gender=${demo.gender}&birth=${demo.birth}`;
          return;
        }
      }
    
      // Ëã•Êú™Êèê‰æõÊÄßÂà• ‚Üí Èö®Ê©üÁî∑/Â•≥
      if(!gender){ gender = (Math.random()<0.5 ? 'male' : 'female'); }
    
      // Ëß£ÊûêËã±ÊñáÂßìÔºà‰øÆÊ≠£ÁÇ∫ /\s+/Ôºâ
      const parts = enName.split(/\s+/).filter(Boolean);
      const lastEn = (parts.length>1 ? parts.at(-1) : parts[0]||'').toLowerCase();
    
      /* ===== Load data ===== */
      let SURNAME_CATALOG = [];
      let CLASSICS = [];
      try{
        SURNAME_CATALOG = await loadJSON(PATH.surnames);
      }catch(e){
        SURNAME_CATALOG = [{cn:'Êûó', py:'L√≠n', aliases:['lin'], noteEn:'From forest; harmony with nature.', era:'Zhou', famousEn:'Lin Bu ‚Äî Song poet'}];
      }
      try{
        CLASSICS = await loadJSON(PATH.classics);
      }catch(e){ CLASSICS = []; }
    
      /* ===== Surname mapping ===== */
      function mapEnglishToSurname(last){
        const key = (last||'').toLowerCase().replace(/[^a-z]/g,'');
        if(!key) return SURNAME_CATALOG.find(s=>s.cn==='Êûó') || SURNAME_CATALOG[0];
        for(const s of SURNAME_CATALOG){
          if(s.aliases && s.aliases.map(a=>a.toLowerCase()).includes(key)) return s;
        }
        // fuzzy
        const iv = key[0] + key.replace(/[bcdfghjklmnpqrstvwxyz]/g,'');
        let best=null, score=-1;
        for(const s of SURNAME_CATALOG){
          const a = (s.aliases && s.aliases[0]) || ((s.py||'')+'').toLowerCase();
          if(!a) continue;
          const iv2 = a[0] + a.replace(/[^aeiou]/g,'');
          let sc = 0; if(a[0]===key[0]) sc+=2; if(iv===iv2) sc+=2; if(a.includes(key.slice(0,2))) sc+=1;
          if(sc>score){score=sc; best=s;}
        }
        return best || SURNAME_CATALOG[0];
      }
      const s = mapEnglishToSurname(lastEn);
      const cnSurname = s.cn;
      const pySurname = s.py || '';
    
      /* ===== Time, element, zodiac ===== */
      let m=1,d=1;
      if(birth){ const dt=new Date(birth); if(!isNaN(dt)) { m=dt.getMonth()+1; d=dt.getDate(); } }
      const el = MONTH_TO_ELEMENT[m] || 'Wood';
      const elZh = ELEMENT_ZH[el] || 'Êú®';
      const z = zodiac(m,d) || 'Pisces';
      const zInfo = ZODIAC_CN_MAP[z] || ZODIAC_CN_MAP['Pisces'];
    
      /* ===== Given-name selection with strict gender ===== */
      function pickGivenByPool(element, genderStr){
        const pool = FALLBACK_POOL[element] || FALLBACK_POOL.Wood;
        const genderKey = (genderStr.startsWith('f')?'female': (genderStr.startsWith('m')?'male':'neutral'));
        const candidates = [
          ...(pool[genderKey]||[]),
          ...(pool.neutral||[]),
          ...(genderKey!=='female' ? (pool.female||[]) : []),
          ...(genderKey!=='male'   ? (pool.male||[])   : [])
        ];
        const seedStr = [enName.toLowerCase(), birth, genderKey, cnSurname, el, z, d].join('|');
        const idx = pickIndex(candidates.length, seedStr);
        return candidates[idx>=0?idx:0] || pool.neutral?.[0] || pool.female?.[0] || pool.male?.[0];
      }
      const chosen = pickGivenByPool(el, gender);
    
      const cnGiven = chosen.cn;
      const pyGiven  = chosen.py;
      const cnFull = cnSurname + cnGiven;
      const pyFull = `${pySurname} ${pyGiven}`.trim();
    
      /* ===== Classic lookup (optional enrich) ===== */
      function findClassic(char){
        if(!char || !CLASSICS.length) return {};
        return CLASSICS.find(c=>c.char===char) || {};
      }
      const primaryChar = chosen.classicChar || cnGiven.charAt(0);
      const classic = findClassic(primaryChar);
      const sourceEn = classic.sourceEn || chosen.classicSourceEn || '';
      const sourceZh = classic.sourceZh || chosen.classicSourceZh || '';
      const quoteEn  = classic.quoteEn  || chosen.quoteEn  || '';
      const quoteZh  = classic.quoteZh  || chosen.quoteZh  || '';
    
      /* ===== Explanations templates ===== */
      const FE_EN = [
        "Born in month {month}, your nature aligns with {el} ({elZh}). The first character ‚Äú{firstChar}‚Äù steadies emotions and nourishes growth.",
        "The element {el} ({elZh}) colors your temperament with empathy and creativity; ‚Äú{firstChar}‚Äù provides balance and inner poise.",
        "With {elZh} energy, you‚Äôre adaptive and compassionate. ‚Äú{firstChar}‚Äù anchors this flow, turning inspiration into gentle strength."
      ];
      const FE_ZH = [
        "ÁîüÊñº{month}ÊúàÔºå‰∫îË°åÂÅè{elZh}„ÄÇ„Äå{firstChar}„Äç‰ΩøÊ∞£Ë≥™Êõ¥Á©©ÔºåÊ∫´ÊΩ§ËÄåÊúâÂÆöÂäõ„ÄÇ",
        "{elZh}‰πãÊÄßË≥¶‰∫àÈùàÊÄßËàáÂêåÁêÜÔºå„Äå{firstChar}„ÄçË™øÂíåÂÖ∂ÈñìÔºå‰ΩøÂøÉÂ¢ÉÂπ≥Ë°°„ÄÇ",
        "ÂëΩÊ†ºË¶ã{elZh}ÔºåÂñÑÊáâËÆä‰∏îÂÖ∑ÂåÖÂÆπÔºå„Äå{firstChar}„ÄçÂ¶ÇÊ†πÔºå‰ª§ÈùàÊÑüÂåñÁÇ∫Ë∏èÂØ¶ÂäõÈáè„ÄÇ"
      ];
      const ZO_EN = [
        "As a {zodiacEn} ({zodiacZh}), you carry {traitEn}. The second character ‚Äú{secondChar}‚Äù refines this spark into graceful presence.",
        "{zodiacEn} spirits are vivid; ‚Äú{secondChar}‚Äù helps express courage with clarity and kindness.",
        "Under {zodiacEn}, ‚Äú{secondChar}‚Äù channels drive into charm, shaping influence that feels authentic."
      ];
      const ZO_ZH = [
        "Â±¨Êñº{zodiacZh}Ôºå‰Ω†ÂÖ∑{traitZh}ÔºõÁ¨¨‰∫åÂ≠ó„Äå{secondChar}„ÄçÊî∂ÊñÇÈä≥Ê∞£ÔºåÂåñÁÇ∫ÂæûÂÆπÈ¢®Â∫¶„ÄÇ",
        "{zodiacZh}ÂÄãÊÄßÈÆÆÊòéÔºå„Äå{secondChar}„ÄçÂä©‰Ω†‰ª•Ê∏ÖÊô∞ËàáÂñÑÊÑèË°®ÈÅîÂãáÊ∞£„ÄÇ",
        "Âú®{zodiacZh}‰πã‰∏ãÔºå„Äå{secondChar}„ÄçÂ∞éÂºïÂãïËÉΩÊàêÁÇ∫È≠ÖÂäõÔºå‰ΩøÂΩ±ÈüøÂäõÊõ¥ÁúüË™†„ÄÇ"
      ];
      function fmt(tpl, ctx){ return tpl.replace(/\{(\w+)\}/g,(_,k)=>ctx[k]??''); }
      const ctx = {
        month:m, el, elZh,
        firstChar: cnGiven.charAt(0),
        secondChar: cnGiven.charAt(1)||cnGiven.charAt(0),
        zodiacEn: z, zodiacZh:zInfo.cn,
        traitEn: zInfo.traitEn, traitZh: zInfo.traitZh
      };
      const feIdx = pickIndex(FE_EN.length, enName+'|'+birth+'|FE');
      const zoIdx = pickIndex(ZO_EN.length, enName+'|'+birth+'|ZO');
    
      /* ===== Cultural story ===== */
      function buildStory(){
        const sEN = [
          `Your name ${cnFull} (${pyFull}) weaves tradition and self together: ‚Äú${cnGiven.charAt(0)}‚Äù draws on classical imagery (${sourceEn}), while ‚Äú${cnGiven.charAt(1)||cnGiven.charAt(0)}‚Äù mirrors your ${z.toLowerCase()} spirit‚Äî${zInfo.traitEn}. The surname ‚Äú${cnSurname}‚Äù adds lineage and belonging.`,
          `In Chinese, names carry wishes. ${cnFull} speaks of ${chosen.meaningEn||'grace and character'}‚Äîa keepsake you can voice, write, and even seal.`
        ].join(' ');
        const sZH = [
          `‰Ω†ÁöÑÂêçÂ≠ó„Äå${cnFull}„ÄçËûçÂêàÂÇ≥Áµ±ËàáËá™ÊàëÔºöÂÖ∂‰∏ÄÂ≠óÂèñÊÑèÊñº${sourceZh}ÔºåÂÖ∂‰∫åÂ≠óÂëºÊáâ${zInfo.cn}ÁöÑÊ∞£Ë≥™Ôºà${zInfo.traitZh}ÔºâÔºå„Äå${cnSurname}„ÄçÊâøËºâÂÆ∂ÊóèËàáÊ≠∏Â±¨„ÄÇ`,
          `‰∏≠ÊñáÂêçÊâøËºâÁ•ùÈ°ò„ÄÇ„Äå${cnFull}„ÄçÂØìÊÑè${chosen.meaningZh||'È¢®ÈõÖËàáÂìÅÊ†º'}Ôºå‰∏çÂÉÖËÉΩË¢´ÊúóËÆÄÊõ∏ÂØ´Ôºå‰πüËÉΩ‰ª•Âç∞Á´†ÂÖ∏Ëóè„ÄÇ`
        ].join(' ');
        return { en:sEN, zh:sZH };
      }
      const story = buildStory();
    
      /* ===== Write UI ===== */
      $('enName').textContent   = `English Name: ${enName}`;
      $('cnFullName').textContent = cnFull;
      $('pinyinFull').textContent = pyFull;
      $('tagline').innerHTML = `Your exclusive Chinese name is <span class="em zh">${cnFull}</span>. Meaning: <span class="em">${chosen.meaningEn||''}</span>ÔΩú‰Ω†ÁöÑ‰∏≠ÊñáÂêçÂ≠óÊòØ„Äå<span class="em zh">${cnFull}</span>„ÄçÔºåÊÑèÊ∂µÔºö<span class="em zh">${chosen.meaningZh||''}</span>`;
    
      const sNoteEn = s.noteEn || ''; const sEra = s.era || ''; const sFEn = s.famousEn || '';
      $('surnameLine').textContent = `${cnSurname} (${pySurname}) ‚Äî ${sNoteEn}`;
      $('surnameOrigin').innerHTML = `<strong>Origin:</strong> ${sEra||'Classical era'}; famous figure: ${sFEn||'‚Äî'}`;
    
      $('givenLine').textContent = `${cnGiven} (${pyGiven}) ‚Äî ${chosen.meaningEn||''}`;
      $('classicEn').innerHTML = `<strong>Classic Source:</strong> The character ‚Äú${chosen.classicChar||cnGiven.charAt(0)}‚Äù in <em>${sourceEn}</em> ‚Äî ‚Äú${quoteEn}‚Äù.`;
      $('classicZh').innerHTML = `<span class="zh"><strong>ÂÖ∏Á±çÂá∫ËôïÔºö</strong>${sourceZh}‚Äî‚Äî„Äå${quoteZh}„Äç„ÄÇ</span>`;
    
      $('fiveElEn').innerHTML = `<strong>Five-Element Reading:</strong> ${fmt(FE_EN[feIdx], ctx)}`;
      $('fiveElZh').innerHTML = `<span class="zh"><strong>‰∫îË°åËß£ËÆÄÔºö</strong>${fmt(FE_ZH[feIdx], ctx)}</span>`;
      $('zodiacEn').innerHTML = `<strong>Zodiac:</strong> ${fmt(ZO_EN[zoIdx], ctx)}`;
      $('zodiacZh').innerHTML = `<span class="zh"><strong>ÊòüË±°Ôºö</strong>${fmt(ZO_ZH[zoIdx], ctx)}</span>`;
    
      $('storyEn').textContent = story.en;
      $('storyZh').textContent = story.zh;
    
      /* ===== Loading overlay fade out ===== */
      const overlay = document.getElementById('loadingOverlay');
  try { if(overlay){ overlay.classList.add('hide'); setTimeout(()=>overlay.remove(), 900);} } catch(e){}

  /* ====== TTS ====== */
  function speak(text){
    const u = new SpeechSynthesisUtterance(text);
    const v = speechSynthesis.getVoices().find(v=>/zh|cmn|Chinese/i.test(v.lang));
    if(v) u.voice=v; u.lang=v?.lang||'zh-TW'; u.rate=.96; u.pitch=1.04;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  const speakBtn = $('speak');
  if (speakBtn) speakBtn.addEventListener('click', ()=> {
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
    if(cn) speak(cn);
  });

  /* ====== Download PDF ====== */
  const dl = $('download');
  if (dl) dl.addEventListener('click', async ()=>{
    const { jsPDF } = window.jspdf;
    const node = document.querySelector('#cert');
    const canvas = await html2canvas(node, {scale:2});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p','pt','a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const ratio = pageW / canvas.width; const h = canvas.height * ratio;
    pdf.addImage(img,'PNG',0,10,pageW,h);
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || 'HanName';
    pdf.save(`HanName_${cn}.pdf`);
  });

  /* ====== ‚ë° Share ‰∏ªÊåâÈàï + PopoverÔºàÂê´ Web Share APIÔºâ ====== */
  const shareBtn = $('shareMain');
  const sharePop = $('sharePop');
  const xBtn = $('shareX');
  const thBtn = $('shareThreads');
  const igBtn = $('shareIG');

  function openXShare(){
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
    const py = document.getElementById('pinyinFull')?.textContent?.trim() || '';
    const url = encodeURIComponent(location.href);
    const text = encodeURIComponent(`My Chinese name: ${cn} (${py}) ‚Äî crafted by HanName`);
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`,'_blank','noopener');
  }
  function copyFor(label){
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
    const py = document.getElementById('pinyinFull')?.textContent?.trim() || '';
    const lines = [
      `My Chinese name: ${cn} (${py})`,
      `Meaning: ` + (document.getElementById('givenLine')?.textContent?.split('‚Äî')[1]?.trim() || ''),
      `#HanName #ChineseName`
    ];
    const txt = lines.filter(Boolean).join('\n');
    navigator.clipboard.writeText(txt).then(()=> alert(`${label} text copied! Paste in your app to post.`));
  }

  if (shareBtn){
    shareBtn.addEventListener('click', async () => {
      // ÂéüÁîüÂàÜ‰∫´ÔºàËã•ÊîØÊè¥ÔºåÁõ¥Êé•Ëµ∞Ôºâ
      const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
      const py = document.getElementById('pinyinFull')?.textContent?.trim() || '';
      const shareData = {
        title: 'HanName Certificate',
        text: `My Chinese name: ${cn} (${py}) ‚Äî crafted by HanName`,
        url: location.href
      };
      if (navigator.share){
        try { await navigator.share(shareData); return; } catch(e){ /* fallback to popover */ }
      }
      // FallbackÔºöÂ±ïÈñã popover
      sharePop?.classList.toggle('open');
      sharePop?.setAttribute('aria-hidden', sharePop.classList.contains('open') ? 'false' : 'true');
    });
    // ÈªûÂ§ñÈù¢ÈóúÈñâ
    document.addEventListener('click', (e)=>{
      if (!sharePop?.classList.contains('open')) return;
      const within = e.composedPath().includes(shareBtn) || e.composedPath().includes(sharePop);
      if (!within) { sharePop.classList.remove('open'); sharePop.setAttribute('aria-hidden','true'); }
    });
  }
  xBtn && xBtn.addEventListener('click', openXShare);
  thBtn && thBtn.addEventListener('click', ()=>copyFor('Threads'));
  igBtn && igBtn.addEventListener('click', ()=>copyFor('Instagram'));
})();
  </script>

  <!-- Floating zh animation (unchanged) -->
  <script>
(function(){
  const floatBox = document.getElementById('floatingZh');
  if(!floatBox) return;
  function spawn(){
    floatBox.innerHTML = '';
    const words = ['‰Ω†ÁöÑÂêçÂ≠ó','Ê≠£Âú®','Ë®≠Ë®à‰∏≠','ÂÑ™ÈõÖ','Âπ≥Ë°°','ÈùàÊÑü','ÊñáÂåñ','ÂÖ∏ÈõÖ','Ë©©ÊÑè','ÂíåÈ≥¥'];
    const W = window.innerWidth, H = window.innerHeight;
    const N = 16;
    for(let i=0;i<N;i++){
      const span = document.createElement('span');
      span.textContent = words[i % words.length];
      const x = Math.random() * (W - 80);
      const y = Math.random() * (H - 40);
      const delay = (Math.random() * 2).toFixed(2);
      const dur = (5 + Math.random() * 4).toFixed(2);
      span.style.left = `${x}px`;
      span.style.top  = `${y}px`;
      span.style.animationDuration = `${dur}s`;
      span.style.animationDelay = `${delay}s`;
      floatBox.appendChild(span);
    }
  }
  spawn();
  setInterval(spawn, 2800);
})();
  </script>
</body>
</html>