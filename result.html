<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HanName â€” Your Chinese Name Certificate</title>
  <meta name="description" content="A bilingual, culturally-rich Chinese name certificate with pronunciation, literature sources, five-element analysis, and zodiac insights." />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Noto+Serif+TC:wght@400;500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <base href="https://joy-trycoding.github.io/hanname2/">

  <style>
    /* Loading overlay */
.loading-overlay{
  position: fixed; inset: 0; background: rgba(245,241,232,0.9);
  display:flex; align-items:center; justify-content:center;
  z-index:9999; transition: opacity .6s ease, visibility .6s ease;
  overflow:hidden;
}
.loading-overlay.hide{ opacity:0; visibility:hidden; }

/* ä¸­å¤®è¨Šæ¯ */
.loading-msg{
  position: relative; z-index:2;
  font-family:'Noto Serif TC','Playfair Display',serif;
  font-size:22px; color:#444; letter-spacing:.2em;
  background: rgba(255,255,255,0.6);
  padding:10px 16px; border-radius:8px; border:1px solid #e7e0d2;
  box-shadow: 0 6px 30px rgba(0,0,0,.05);
}

/* èƒŒæ™¯æ¼‚æµ®çš„æ¼¢å­— */
.floating-zh{
  position:absolute; inset:0; overflow:hidden; z-index:1; pointer-events:none;
}

.floating-zh span{
  position:absolute; font-family:'Noto Serif TC','Playfair Display',serif;
  font-size: clamp(18px, 3vw, 32px); color:#000;
  opacity:.06; white-space:nowrap; user-select:none;
  animation: floatUp 6s linear infinite;
}

@keyframes floatUp{
  0%   { transform: translateY(20px); opacity:0.02; }
  10%  { opacity:.08; }
  90%  { opacity:.08; }
  100% { transform: translateY(-40px); opacity:0; }
}

    :root{ --paper:#F5F1E8; --ink:#1C1B1A; --accent:#C49A6C; --muted:#666; --line:#E5DFD3; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--paper); color:var(--ink); font-family:'Inter','Noto Serif TC',serif;}
    a{color:inherit}
    .header{display:flex; align-items:center; gap:10px; padding:10px 16px}
    .header .brand img{height:32px}

    .wrap{max-width:940px; margin:0 auto; padding:16px}
    .certificate{background:#fff; border:8px double var(--line); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.06); padding:24px;}
    .title{font-family:'Playfair Display','Noto Serif TC',serif; text-align:center; font-size:28px; margin:6px 0 2px}
    .subtitle{text-align:center; color:#444; font-size:13px; margin:0 0 10px}
    .divider{height:2px; background:var(--line); margin:12px 0 18px}

    .name-block{display:grid; gap:4px; justify-items:center; margin:8px 0 16px}
    .cn-name{font-family:'Noto Serif TC','Playfair Display',serif; font-size:46px; font-weight:700; letter-spacing:.06em}
    .pinyin{font-size:16px; color:var(--accent)}
    .btn{appearance:none; border:1px solid var(--ink); background:var(--ink); color:#fff; padding:8px 14px; border-radius:999px; cursor:pointer}
    .btn:hover{opacity:.92}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .panel{border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff}
    .panel h3{font-family:'Playfair Display','Noto Serif TC',serif; font-size:18px; margin:0 0 8px}
    .panel p{margin:6px 0; line-height:1.7}
    .em{color:#222; font-weight:600}
    .zh{font-family:'Noto Serif TC','Playfair Display',serif}

    .analysis{margin-top:10px}

    .actions{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px}

    .footnote{margin-top:12px; font-size:12px; color:#666; text-align:center}

    @media (max-width: 880px){ .grid{grid-template-columns:1fr} .cn-name{font-size:40px} }
  </style>
</head>
<body>
  <header class="header">
    <a class="brand" href="index.html" aria-label="Back to HanName home">
      <img src="assets/logo.jpg" alt="HanName logo" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'HanName',style:'font-weight:700;font-family:Playfair Display, Noto Serif TC, serif;font-size:18px;' }))" />
    </a>
  </header>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-msg">ä½ çš„åå­—æ­£åœ¨è¨­è¨ˆä¸­â€¦</div>
    <div id="floatingZh" class="floating-zh"></div>
  </div>
  <main class="wrap">
    <section id="cert" class="certificate">
      <h1 class="title">Chinese Name Certificate</h1>
      <p class="subtitle">A personalized cultural identity crafted from sound, meaning, literature, Five Elements, and zodiac.</p>
      <div class="divider"></div>

      <div class="name-block">
        <div id="enName" class="en-name" style="font-size:14px; color:#555">English Name: â€”</div>
        <div id="cnFullName" class="cn-name">â€”</div>
        <div class="pinyin"><span id="pinyinFull">â€”</span> <button id="speak" class="btn" data-track="play-tts">ğŸ”Š</button></div>
        <div id="tagline" style="font-size:14px; color:#333"></div>
      </div>

      <div class="grid">
        <article class="panel" id="surnamePanel">
          <h3>Surname Â· å§“æ°</h3>
          <p id="surnameLine"></p>
          <p id="surnameOrigin"></p>
        </article>

        <article class="panel" id="givenPanel">
          <h3>Given Name Â· åå­—</h3>
          <p id="givenLine"></p>
          <div class="analysis">
            <p id="classicEn"></p>
            <p id="classicZh" class="zh"></p>
            <p id="fiveElEn"></p>
            <p id="fiveElZh" class="zh"></p>
            <p id="zodiacEn"></p>
            <p id="zodiacZh" class="zh"></p>
          </div>
        </article>
      </div>

      <div class="actions">
        <button id="download" class="btn" data-track="download-cert">Download Certificate</button>
        <button id="share" class="btn" data-track="share">Share</button>
        <a id="gift" class="btn" href="index.html#pricing" data-track="seal-gift">Create Your Seal Gift</a>
      </div>

      <p class="footnote">Tip: Save this certificate as a PDF or print it.ï½œå°æé†’ï¼šå¯ä¸‹è¼‰ PDF æˆ–åˆ—å°ä¿å­˜ã€‚</p>
    </section>
  </main>

  <!-- libs for PDF download (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Single, clean module script -->
  <script type="module">
  // ====== Config & helpers ======
  const ROOT = "/hanname2"; // å›ºå®šå°ˆæ¡ˆæ ¹è·¯å¾‘ï¼Œé¿å…å‹•æ…‹ base å¤±æº–
  const PATH = {
    surnames: `${ROOT}/data/surnames.json?v=fix2`,
    classics: `${ROOT}/data/classics.json?v=fix2`
  };

  const $ = (id)=>document.getElementById(id);
  const pick = (arr, seed)=> arr[Math.abs(seed)%arr.length];
  const hash = (s)=> s.split('').reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0) | 0, 0);

  async function loadJSON(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} while loading ${url}`);
    return res.json();
  }

  // Five elements (demo)
  const MONTH_TO_ELEMENT = {1:'Water',2:'Wood',3:'Wood',4:'Wood',5:'Fire',6:'Fire',7:'Fire',8:'Earth',9:'Metal',10:'Metal',11:'Water',12:'Water'};
  const ELEMENT_ZH = {Wood:'æœ¨', Fire:'ç«', Earth:'åœŸ', Metal:'é‡‘', Water:'æ°´'};

  // Western zodiac
  function zodiac(m,d){
    const z=[['Capricorn',1,19],['Aquarius',2,18],['Pisces',3,20],['Aries',4,19],['Taurus',5,20],['Gemini',6,20],['Cancer',7,22],['Leo',8,22],['Virgo',9,22],['Libra',10,22],['Scorpio',11,21],['Sagittarius',12,21],['Capricorn',12,31]];
    for(const [name,mm,dd] of z){ if(m<mm || (m===mm && d<=dd)) return name; }
  }
  const ZODIAC_CN_MAP = {
    Pisces:{cn:'é›™é­š', cnStar:'å¥å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'sensitive and insightful', traitZh:'æ„Ÿæ€§è€Œå…·æ´å¯ŸåŠ›'},
    Aries:{cn:'ç‰¡ç¾Š', cnStar:'è§’å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'decisive and pioneering', traitZh:'æœæ•¢é–‹å‰µ'},
    Taurus:{cn:'é‡‘ç‰›', cnStar:'æ˜´å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'grounded and persevering', traitZh:'è¸å¯¦å …å®š'},
    Gemini:{cn:'é›™å­', cnStar:'è»«å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'curious and expressive', traitZh:'å¥½å¥‡å–„è¨€'},
    Cancer:{cn:'å·¨èŸ¹', cnStar:'æˆ¿å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'nurturing and protective', traitZh:'é—œæ‡·å®ˆè­·'},
    Leo:{cn:'ç…å­', cnStar:'å¿ƒå®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'radiant and confident', traitZh:'è‡ªä¿¡é–ƒè€€'},
    Virgo:{cn:'è™•å¥³', cnStar:'å¥³å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'refined and meticulous', traitZh:'ç´°è†©è¬›ç©¶'},
    Libra:{cn:'å¤©ç§¤', cnStar:'è¡¡å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'balanced and graceful', traitZh:'å¹³è¡¡å„ªé›…'},
    Scorpio:{cn:'å¤©è ', cnStar:'å°¾å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'deep and resolute', traitZh:'æ·±æ²‰æœæ±º'},
    Sagittarius:{cn:'å°„æ‰‹', cnStar:'ç®•å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'far-sighted and free', traitZh:'é å¿—è‡ªç”±'},
    Capricorn:{cn:'æ‘©ç¾¯', cnStar:'ç‰›å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'enduring and disciplined', traitZh:'éŸŒæ€§è‡ªå¾‹'},
    Aquarius:{cn:'æ°´ç“¶', cnStar:'å±å®¿ï¼ˆç¤ºä¾‹ï¼‰', traitEn:'original and humane', traitZh:'å‰µæ–°åšæ„›'}
  };

  // Given-name pool (demo) â€” åŸæ¨£ä¿ç•™
  const NAME_POOL = { /* çœç•¥ï¼šä½¿ç”¨ä½ ç¾æœ‰çš„ NAME_POOL å…§å®¹ï¼ˆåŒä½ æª”æ¡ˆï¼‰ */ 
    Wood:{female:[{cn:'æ¸…é›²',py:'QÄ«ngyÃºn',classicChar:'é›²',classicSourceEn:'Wang Wei, Tang poetry',classicSourceZh:'ç‹ç¶­Â·å”è©©',quoteZh:'é›²ç„¡å¿ƒä»¥å‡ºå²«',quoteEn:'Clouds go freely over hills',meaningEn:'clarity and freedom',meaningZh:'æ¸…æ¾ˆè‡ªç”±'},{cn:'é›…å¯§',py:'YÇnÃ­ng',classicChar:'é›…',classicSourceEn:'Shijing Â· Da Ya (title uses é›…)',classicSourceZh:'ã€Šè©©ç¶“Â·å¤§é›…ã€‹',quoteZh:'å¤§é›…',quoteEn:'Da Ya',meaningEn:'elegance & serenity',meaningZh:'å„ªé›…èˆ‡å®‰å¯§'}],male:[{cn:'åšé ',py:'BÃ³yuÇn',classicChar:'é ',classicSourceEn:'Qu Yuan Â· Lisao imagery',classicSourceZh:'å±ˆåŸÂ·é›¢é¨·æ„è±¡',quoteZh:'è·¯æ¼«æ¼«å…¶ä¿®é å…®',quoteEn:'The road ahead is long and far',meaningEn:'breadth and vision',meaningZh:'èƒ¸è¥Ÿèˆ‡å®é '}]},
    Fire:{female:[{cn:'æ›‰æ©',py:'XiÇoÄ“n',classicChar:'æ›‰',classicSourceEn:'Song Ci imagery',classicSourceZh:'å®‹è©æ„è±¡',quoteZh:'æ›‰é¢¨æ®˜æœˆ',quoteEn:'Dawn breeze and waning moon',meaningEn:'gentle warmth',meaningZh:'æº«æŸ”æ™¨å…‰'}],male:[{cn:'æ–‡è»’',py:'WÃ©nxuÄn',classicChar:'æ–‡',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteZh:'å­¸è€Œä¸å­',quoteEn:'Be never weary of learning',meaningEn:'cultured and bright',meaningZh:'æ–‡é›…æ˜æœ—'}]},
    Earth:{female:[{cn:'éœç‘¤',py:'JÃ¬ngyÃ¡o',classicChar:'ç‘¤',classicSourceEn:'Tang poetry',classicSourceZh:'å”è©©',quoteZh:'ç‘¤å°æœˆä¸‹',quoteEn:'Under moonlight at Jade Terrace',meaningEn:'quiet radiance',meaningZh:'éœä¸­ç”Ÿå…‰'}],male:[{cn:'å¿—å®',py:'ZhÃ¬hÃ³ng',classicChar:'å¿—',classicSourceEn:'Mencius',classicSourceZh:'ã€Šå­Ÿå­ã€‹',quoteZh:'å¿—æ–¼é“ï¼Œæ“šæ–¼å¾·',quoteEn:'Set your will on the Way',meaningEn:'great aspiration',meaningZh:'å®é ä¹‹å¿—'}]},
    Metal:{female:[{cn:'æ™¯è¨€',py:'JÇngyÃ¡n',classicChar:'è¨€',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteZh:'è¨€ç‚ºå¿ƒè²',quoteEn:'Words are the voice of the heart',meaningEn:'clear expression',meaningZh:'æ¸…æœ—ä¹‹è¨€'}],male:[{cn:'å®‡è¾°',py:'YÇ”chÃ©n',classicChar:'è¾°',classicSourceEn:'Song Ci',classicSourceZh:'å®‹è©',quoteZh:'è‰¯è¾°ç¾æ™¯',quoteEn:'A fine time and beautiful scene',meaningEn:'cosmic poise',meaningZh:'å®‡é‡èˆ‡æ™‚è¾°'}]},
    Water:{female:[{cn:'å¿ƒå¦‚',py:'XÄ«nrÃº',classicChar:'å¿ƒ',classicSourceEn:'Literary aphorism',classicSourceZh:'æ–‡äººèª',quoteZh:'ä¸€å¿ƒå¦‚æ°´',quoteEn:'Let the heart be like water',meaningEn:'pure-hearted',meaningZh:'å¿ƒæ¾„å¦‚æ°´'}],male:[{cn:'æ¸…æŸ',py:'QÄ«ngbÇi',classicChar:'æŸ',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteZh:'æ­²å¯’ï¼Œç„¶å¾ŒçŸ¥æ¾æŸä¹‹å¾Œå‡‹ä¹Ÿ',quoteEn:'In winter, we see pine and cypress endure',meaningEn:'clarity & integrity',meaningZh:'æ¸…æ­£èˆ‡ç¯€æ“'}]}
  };

 // ====== App init ======
(async function init(){}

// === Loading overlayï¼šå…ˆé¡¯ç¤ºå‹•ç•« ===
const overlay = document.getElementById('loadingOverlay');
const floatBox = document.getElementById('floatingZh');

function spawnFloatingZh(){
  if (!floatBox) return;
  floatBox.innerHTML = '';
  const words = ['ä½ çš„åå­—','æ­£åœ¨','è¨­è¨ˆä¸­','å„ªé›…','å¹³è¡¡','éˆæ„Ÿ','æ–‡åŒ–','å…¸é›…','è©©æ„','å’Œé³´'];
  const W = window.innerWidth, H = window.innerHeight;
  const N = 16;
  for(let i=0;i<N;i++){
    const span = document.createElement('span');
    span.textContent = words[i % words.length];
    const x = Math.random() * (W - 80);
    const y = Math.random() * (H - 40);
    const delay = (Math.random() * 2).toFixed(2);
    const dur = (5 + Math.random() * 4).toFixed(2);
    span.style.left = `${x}px`;
    span.style.top  = `${y}px`;
    span.style.animationDuration = `${dur}s`;
    span.style.animationDelay = `${delay}s`;
    floatBox.appendChild(span);
  }
}
spawnFloatingZh();
const floatTimer = setInterval(spawnFloatingZh, 2800);

// === 1) è§£æ Query ===
const qs = new URLSearchParams(location.search);
let enName = (qs.get('name') || '').trim();
let gender = (qs.get('gender') || '').toLowerCase();
const birth = qs.get('birth') || '';

const DEMO = [
  {en:'Emily Smith', gender:'female', birth:'1994-03-02'},
  {en:'Daniel Lee', gender:'male',   birth:'1992-07-15'},
  {en:'Sophia Chen', gender:'female',birth:'1996-06-28'}
];
if(!enName){
  const demo = DEMO[Math.floor(Math.random()*DEMO.length)];
  enName = demo.en;
  if(!qs.get('gender')) gender = demo.gender;
  if(!qs.get('birth')) {
    // ä»¥ demo å€¼åˆ·æ–°ç¶²å€ï¼Œä¹‹å¾Œæµç¨‹ä¸€è‡´
    location.search = `?name=${encodeURIComponent(enName)}&gender=${demo.gender}&birth=${demo.birth}`;
    return; // ç­‰é é¢é‡æ–°è¼‰å…¥
  }
}

// è‹±æ–‡å§“ï¼ˆæœ€å¾Œä¸€æ®µå­—ï¼‰
const parts = enName.split(/\s+/).filter(Boolean);
const lastEn = (parts.length > 1 ? parts.at(-1) : parts[0] || '').toLowerCase();

// === 2) è¼‰å…¥è³‡æ–™ ===
let SURNAME_CATALOG = [];
let CLASSICS = [];
let GIVENS = [];

try{
  SURNAME_CATALOG = await loadJSON(PATH.surnames);
  console.log('[HanName] surnames.json loaded:', SURNAME_CATALOG.length);
}catch(e){
  console.warn('Failed to load surnames.json â€” fallback to LIN.', e);
  SURNAME_CATALOG = [{cn:'æ—', py:'LÃ­n', aliases:['lin']}];
}

if (PATH.classics){
  try{
    CLASSICS = await loadJSON(PATH.classics);
    console.log('[HanName] classics.json loaded:', CLASSICS.length);
  }catch(e){
    console.warn('Failed to load classics.json', e);
    CLASSICS = [];
  }
}

if (PATH.givens){
  try{
    GIVENS = await loadJSON(PATH.givens);
    console.log('[HanName] givenNameData.json loaded:', GIVENS.length);
  }catch(e){
    console.warn('Failed to load givenNameData.json', e);
    GIVENS = [];
  }
}

// === 3) å§“æ°æ˜ å°„ ===
function mapEnglishToSurname(last){
  const key = (last||'').toLowerCase().replace(/[^a-z]/g,'');
  if(!key) return SURNAME_CATALOG.find(s=>s.cn==='æ—') || SURNAME_CATALOG[0];
  for(const s of SURNAME_CATALOG) {
    if(s.aliases && s.aliases.map(a=>a.toLowerCase()).includes(key)) return s;
  }
  // fuzzyï¼ˆç°¡æ˜“ï¼‰
  const iv = key[0] + key.replace(/[bcdfghjklmnpqrstvwxyz]/g,'');
  let best=null, score=-1;
  for(const s of SURNAME_CATALOG){
    const a = (s.aliases && s.aliases[0]) || ((s.py||'')+"").toLowerCase();
    if(!a) continue;
    const iv2 = a[0] + a.replace(/[^aeiou]/g,'');
    let sc = 0; if(a[0]===key[0]) sc+=2; if(iv===iv2) sc+=2; if(a.includes(key.slice(0,2))) sc+=1;
    if(sc>score){score=sc; best=s;}
  }
  return best || SURNAME_CATALOG[0];
}
const s = mapEnglishToSurname(lastEn);
const cnSurname = s.cn;
const pySurname = s.py || '';

// === 4) äº”è¡Œ & æ˜Ÿåº§ ===
let m=1,d=1;
if(birth){
  const dt=new Date(birth);
  if(!isNaN(dt)) { m=dt.getMonth()+1; d=dt.getDate(); }
}
const el = MONTH_TO_ELEMENT[m] || 'Wood';
const elZh = ELEMENT_ZH[el] || 'æœ¨';

function zodiac(mm,dd){
  const z=[['Capricorn',1,19],['Aquarius',2,18],['Pisces',3,20],['Aries',4,19],['Taurus',5,20],['Gemini',6,20],['Cancer',7,22],['Leo',8,22],['Virgo',9,22],['Libra',10,22],['Scorpio',11,21],['Sagittarius',12,21],['Capricorn',12,31]];
  for(const [name,MM,DD] of z){ if(mm<MM || (mm===MM && dd<=DD)) return name; }
}
const z = zodiac(m,d) || 'Pisces';
const zInfo = ZODIAC_CN_MAP[z] || ZODIAC_CN_MAP['Pisces'];

// === 5) ç¨®å­ï¼ˆå¯é‡ç¾/éš¨æ©Ÿï¼‰ï¼† æŒ‘é¸ Given Name ===
const modeRandom = (qs.get('var') || '').toLowerCase() === 'random';   // &var=random æ¯æ¬¡éƒ½ä¸åŒ
const salt = qs.get('salt') || '';                                      // &salt=XYZ æ‰‹å‹•åˆ‡ç‰ˆ

function hash2(s){
  let h = 2166136261 >>> 0; // FNV-1a
  for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h | 0;
}
function makeSeedString(){
  return [
    (enName || '').toLowerCase(),
    (birth  || '').toLowerCase(),
    (gender || '').toLowerCase(),
    (lastEn || '').toLowerCase(),
    (cnSurname || ''),
    (el || ''),
    (z || ''),
    salt
  ].join('|');
}
function seededIndex(list, seedStr){
  if (!list || !list.length) return -1;
  let seed = hash2(seedStr);
  if (modeRandom) {
    const rand = (crypto?.getRandomValues)
      ? crypto.getRandomValues(new Uint32Array(1))[0]
      : Math.floor(Math.random() * 0xFFFFFFFF);
    seed ^= rand;
  }
  return Math.abs(seed) % list.length;
}

// æœ€å°å‚™æ´æ± ï¼ˆçœŸçš„æŠ“ä¸åˆ° GIVENS æ‰æœƒç”¨åˆ°ï¼‰
const FALLBACK_POOL = {
  Wood:{ female:[{cn:'é›…å¯§',py:'YÇnÃ­ng',classicChar:'é›…',classicSourceEn:'Shijing Â· Da Ya',classicSourceZh:'ã€Šè©©ç¶“Â·å¤§é›…ã€‹',quoteEn:'Da Ya',quoteZh:'å¤§é›…',meaningEn:'elegance & serenity',meaningZh:'å„ªé›…èˆ‡å®‰å¯§'}],
         male:  [{cn:'åšé ',py:'BÃ³yuÇn',classicChar:'é ',classicSourceEn:'Qu Yuan Â· Lisao',classicSourceZh:'å±ˆåŸÂ·é›¢é¨·',quoteEn:'The road ahead is long',quoteZh:'è·¯æ¼«æ¼«å…¶ä¿®é å…®',meaningEn:'breadth and vision',meaningZh:'èƒ¸è¥Ÿèˆ‡å®é '}] },
  Fire:{ female:[{cn:'æ›‰æ©',py:'XiÇoÄ“n',classicChar:'æ›‰',classicSourceEn:'Song Ci',classicSourceZh:'å®‹è©',quoteEn:'Dawn breeze and waning moon',quoteZh:'æ›‰é¢¨æ®˜æœˆ',meaningEn:'gentle warmth',meaningZh:'æº«æŸ”æ™¨å…‰'}],
         male:  [{cn:'æ–‡è»’',py:'WÃ©nxuÄn',classicChar:'æ–‡',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteEn:'Be never weary of learning',quoteZh:'å­¸è€Œä¸å­',meaningEn:'cultured and bright',meaningZh:'æ–‡é›…æ˜æœ—'}] },
  Earth:{ female:[{cn:'éœç‘¤',py:'JÃ¬ngyÃ¡o',classicChar:'ç‘¤',classicSourceEn:'Tang poetry',classicSourceZh:'å”è©©',quoteEn:'Jade terrace under moon',quoteZh:'ç‘¤å°æœˆä¸‹',meaningEn:'quiet radiance',meaningZh:'éœä¸­ç”Ÿå…‰'}],
         male:  [{cn:'å¿—å®',py:'ZhÃ¬hÃ³ng',classicChar:'å¿—',classicSourceEn:'Mencius',classicSourceZh:'ã€Šå­Ÿå­ã€‹',quoteEn:'Set your will on the Way',quoteZh:'å¿—æ–¼é“ï¼Œæ“šæ–¼å¾·',meaningEn:'great aspiration',meaningZh:'å®é ä¹‹å¿—'}] },
  Metal:{ female:[{cn:'æ™¯è¨€',py:'JÇngyÃ¡n',classicChar:'è¨€',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteEn:'Words are the voice of the heart',quoteZh:'è¨€ç‚ºå¿ƒè²',meaningEn:'clear expression',meaningZh:'æ¸…æœ—ä¹‹è¨€'}],
         male:  [{cn:'å®‡è¾°',py:'YÇ”chÃ©n',classicChar:'è¾°',classicSourceEn:'Song Ci',classicSourceZh:'å®‹è©',quoteEn:'A fine time and scene',quoteZh:'è‰¯è¾°ç¾æ™¯',meaningEn:'cosmic poise',meaningZh:'å®‡é‡èˆ‡æ™‚è¾°'}] },
  Water:{ female:[{cn:'å¿ƒå¦‚',py:'XÄ«nrÃº',classicChar:'å¿ƒ',classicSourceEn:'Aphorism',classicSourceZh:'æ–‡äººèª',quoteEn:'Let the heart be like water',quoteZh:'ä¸€å¿ƒå¦‚æ°´',meaningEn:'pure-hearted',meaningZh:'å¿ƒæ¾„å¦‚æ°´'}],
         male:  [{cn:'æ¸…æŸ',py:'QÄ«ngbÇi',classicChar:'æŸ',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteEn:'Pine & cypress endure',quoteZh:'æ­²å¯’ç„¶å¾ŒçŸ¥æ¾æŸä¹‹å¾Œå‡‹ä¹Ÿ',meaningEn:'clarity & integrity',meaningZh:'æ¸…æ­£èˆ‡ç¯€æ“'}] }
};

function pickGivenByData(element, gender){
  const g = (gender || '').toLowerCase().startsWith('f') ? 'female'
        : (gender || '').toLowerCase().startsWith('m') ? 'male'
        : '';
  let cand = GIVENS.filter(x =>
    (!element || (x.element||'').toLowerCase() === element.toLowerCase()) &&
    (!g || (x.gender||'').toLowerCase() === g)
  );
  if (!cand.length) cand = GIVENS.filter(x => (x.element||'').toLowerCase() === (element||'').toLowerCase());
  if (!cand.length) cand = GIVENS.slice();
  if (!cand.length) {
    const pool = FALLBACK_POOL[element] || FALLBACK_POOL.Wood || { female:[], male:[] };
    cand = (g==='female' ? (pool.female||[]) : (pool.male||[]));
  }
  const idx = seededIndex(cand, makeSeedString());
  return idx >= 0 ? cand[idx] : null;
}

let chosen = pickGivenByData(el, gender);
if (!chosen) {
  chosen = FALLBACK_POOL.Wood.female[0];
}

const cnGiven = chosen.cn;
const pyGiven  = chosen.py;
const cnFull = cnSurname + cnGiven;
const pyFull = `${pySurname} ${pyGiven}`.trim();

// === 6) ç¶“å…¸æŸ¥æ‰¾ï¼ˆå¯ç”¨ classics.json è£œå¼· chosen çš„å¼•ç”¨ï¼‰ ===
function findClassic(char){
  if (!char || !CLASSICS.length) return {};
  return CLASSICS.find(c => c.char === char) || {};
}
const primaryChar = chosen.classicChar || cnGiven.charAt(0);
const classic = findClassic(primaryChar);
const sourceEn = classic.sourceEn || chosen.classicSourceEn || '';
const sourceZh = classic.sourceZh || chosen.classicSourceZh || '';
const quoteEn  = classic.quoteEn  || chosen.quoteEn  || '';
const quoteZh  = classic.quoteZh  || chosen.quoteZh  || '';

// === 7) äº”è¡Œ/æ˜Ÿåº§æ¨¡æ¿ï¼ˆ10çµ„ï¼‰ï¼Œç”¨ç¨®å­é¸ç‰ˆæœ¬ï¼ˆå¯é‡ç¾æˆ–éš¨æ©Ÿï¼‰ ===
const FE_TEMPLATES_EN = [
  "Born in month {month}, your nature aligns with {el} ({elZh}), symbolizing renewal and vitality. The second character â€œ{secondChar}â€ strengthens inner balance and brings harmony to your temperament.",
  "The energy of {el} ({elZh}) dominates your birth month, granting creativity and growth. By using â€œ{secondChar}â€, your name softens excess vigor and guides it toward stability.",
  "Aprilâ€™s {el} element flows through you, evoking vitality and empathy. The character â€œ{secondChar}â€ nurtures this flow, creating calm strength and steady purpose.",
  "The essence of {elZh} in your chart emphasizes compassion and growth. â€œ{secondChar}â€ anchors these qualities, bringing balance between idealism and action.",
  "Your elemental path of {el} lends flexibility and intuition. The nameâ€™s latter part â€œ{secondChar}â€ acts as a steadying root, harmonizing your emotions.",
  "With {elZh} predominant, you possess natural empathy and an artistic touch. â€œ{secondChar}â€ enhances resilience, letting you grow through challenges.",
  "Born under strong {el} energy, you thrive in connection and learning. â€œ{secondChar}â€ stabilizes your curiosity, grounding inspiration into real action.",
  "Month {month} aligns with {elZh}, symbol of harmony and renewal. The second glyph â€œ{secondChar}â€ enriches emotional balance and steady growth.",
  "The presence of {el} grants resilience and compassion. â€œ{secondChar}â€ weaves stability into your bright personality, balancing heart and reason.",
  "{elZh} rules your birth season, gifting openness and adaptability. â€œ{secondChar}â€ completes this harmony, allowing you to stay calm amid growth."
];
const ZO_TEMPLATES_EN = [
  "As a {zodiacEn} ({zodiacZh}), youâ€™re bold and passionate â€” the first character â€œ{firstChar}â€ channels that fire into refinement and grace.",
  "{zodiacEn} souls seek adventure; â€œ{firstChar}â€ mirrors that spirit yet adds poise, helping you express courage with wisdom.",
  "A true {zodiacEn} is radiant and driven â€” â€œ{firstChar}â€ transforms impulse into confident charm, revealing natural leadership.",
  "Under the sign of {zodiacEn}, the word â€œ{firstChar}â€ refines your fiery drive into creativity and influence.",
  "{zodiacEn} hearts blaze with independence â€” â€œ{firstChar}â€ channels this flame toward grace and authentic self-expression.",
  "As a {zodiacEn}, â€œ{firstChar}â€ celebrates your fearless heart and helps project confidence that inspires others.",
  "The {zodiacEn} constellation symbolizes courage and renewal â€” â€œ{firstChar}â€ magnifies your pioneering light.",
  "For a spirited {zodiacEn}, â€œ{firstChar}â€ acts as a talisman of clarity, helping channel passion into purpose.",
  "A {zodiacEn} thrives on challenge; â€œ{firstChar}â€ refines your impulsive side, turning courage into charisma.",
  "{zodiacEn} energy radiates confidence â€” â€œ{firstChar}â€ echoes that light, bringing you both elegance and magnetism."
];
const FE_TEMPLATES_ZH = [
  "ç”Ÿæ–¼{month}æœˆï¼Œå‘½æ ¼å{elZh}ï¼Œè±¡å¾µç”Ÿé•·èˆ‡å¸Œæœ›ã€‚åå­—ç¬¬äºŒå­—ã€Œ{secondChar}ã€èª¿å’Œäº”è¡Œï¼Œä½¿æ°£è³ªæ›´ç‚ºå‡è¡¡ç©©å®šã€‚",
  "{elZh}ä¹‹æ°£ä¸»å°ä½ çš„å‡ºç”Ÿæœˆï¼Œå¸¶ä¾†å‰µé€ èˆ‡éˆæ€§ã€‚ã€Œ{secondChar}ã€ä¸€å­—å¹³è¡¡æ—ºç››çš„ç”Ÿå‘½åŠ›ï¼Œä½¿ä½ å…¼å…·æŸ”éŸŒèˆ‡å …å®šã€‚",
  "{month}æœˆçš„{elZh}ä¹‹æ€§ï¼Œè³¦äºˆä½ æˆé•·èˆ‡åŒç†å¿ƒã€‚ã€Œ{secondChar}ã€æº«æ½¤å…¶é–“ï¼Œä½¿èƒ½é‡æµå‹•è€Œä¸èºï¼Œå…§å¤–å’Œè«§ã€‚",
  "äº”è¡Œå±¬{elZh}è€…ï¼Œå¤šå…·åŒ…å®¹èˆ‡é€²å–å¿ƒã€‚ã€Œ{secondChar}ã€ä½¿å…¶æ°£è±¡ä¸­åº¸ï¼Œè®“ç†æƒ³èˆ‡è¡Œå‹•é”åˆ°å¹³è¡¡ã€‚",
  "å‘½æ ¼ä¸­{elZh}æ—ºç››ï¼Œéˆæ°£æµå‹•ï¼Œã€Œ{secondChar}ã€å¦‚æ ¹èˆ¬ç©©å®šï¼Œè®“æƒ…æ„Ÿèˆ‡ç†æ™ºå…±ç”Ÿã€‚",
  "{elZh}ä¸»ä»èˆ‡è—ï¼Œã€Œ{secondChar}ã€å¢å…¶å …éŸŒï¼Œä½¿ä½ åœ¨æŒ‘æˆ°ä¸­ä¾èˆŠæˆé•·ç¶»æ”¾ã€‚",
  "äº”è¡Œå{elZh}ï¼Œä½ å¤©ç”Ÿå–„æ„Ÿä¸”å¯Œå­¸ç¿’åŠ›ï¼Œã€Œ{secondChar}ã€ç©©å®šæƒ…ç·’ï¼Œä½¿éˆæ„ŸåŒ–ç‚ºå¯¦è¸ã€‚",
  "ç”Ÿæ–¼{month}æœˆï¼Œæ‰¿{elZh}ä¹‹æ°£ï¼Œæ€§æƒ…å¹³å’Œè€Œå…·åŒ…å®¹ã€‚ã€Œ{secondChar}ã€ä»¤æ€ç·’æ›´æ¸…æ˜ï¼Œæˆå°±é•·é ä¹‹å¿—ã€‚",
  "å‘½å¸¶{elZh}ï¼Œæ°£è³ªå …æ¯…æº«åšï¼Œã€Œ{secondChar}ã€æ½¤åŒ–å‰›å¼·ï¼Œä½¿ç†æ€§èˆ‡æ„Ÿæ€§ç›¸å¾—ç›Šå½°ã€‚",
  "{elZh}ä¹‹æ€§ï¼Œä½¿ä½ é–‹æœ—è€Œå–„æ‡‰è®Šã€‚ã€Œ{secondChar}ã€è£œè¶³äº”è¡Œï¼Œè®“é€²å–èˆ‡å¯§éœä¸¦å­˜ã€‚"
];
const ZO_TEMPLATES_ZH = [
  "å±¬æ–¼{zodiacZh}çš„ä½ å¤©æ€§ç†±æƒ…æœæ•¢ï¼Œç¬¬ä¸€å­—ã€Œ{firstChar}ã€å°‡é€™ä»½ç«ç„°åŒ–ç‚ºå„ªé›…èˆ‡è‡ªä¿¡ã€‚",
  "{zodiacZh}è±¡å¾µå†’éšªèˆ‡é ˜å…ˆï¼Œã€Œ{firstChar}ã€è®“é€™ä»½è¡å‹æ›´é¡¯æ²‰è‘—ï¼Œå±•ç¾å‹‡æ°£èˆ‡æ™ºæ…§ä¸¦å­˜ã€‚",
  "å…¸å‹çš„{zodiacZh}ç†±æƒ…ç‡çœŸï¼Œã€Œ{firstChar}ã€å­—åŒ–å‹•ç‚ºéœï¼Œè®“è‡ªä¿¡æ›´å…·é­…åŠ›èˆ‡æ„ŸæŸ“åŠ›ã€‚",
  "{zodiacZh}è±¡å¾µå‹‡æ°£èˆ‡å…‰æ˜ï¼Œã€Œ{firstChar}ã€å»¶å±•æ­¤ç‰¹è³ªï¼Œä½¿ä½ ä»¥å‰µæ„èˆ‡åŠ›é‡å½±éŸ¿ä»–äººã€‚",
  "{zodiacZh}çš„éˆé­‚ç†±çƒˆè€Œè‡ªç”±ï¼Œã€Œ{firstChar}ã€å°å¼•é€™è‚¡èƒ½é‡åŒ–ç‚ºçœŸèª çš„è¡¨é”èˆ‡é ˜å°æ°£å ´ã€‚",
  "ä½ çš„{zodiacZh}å€‹æ€§å‰›çƒˆçœŸèª ï¼Œã€Œ{firstChar}ã€å¹³è¡¡å…¶é‹’èŠ’ï¼Œä½¿é­…åŠ›æ›´é¡¯å¾å®¹ã€‚",
  "{zodiacZh}è±¡å¾µé‡ç”Ÿèˆ‡å‹‡æ°£ï¼Œã€Œ{firstChar}ã€è®“ä½ çš„é–‹å‰µç²¾ç¥æ›´å…·æ–¹å‘ã€‚",
  "ä½œç‚º{zodiacZh}ï¼Œä½ å…·é ˜è¢–æ°£å‹¢ï¼Œã€Œ{firstChar}ã€å‘¼æ‡‰æ­¤å…‰ï¼Œä½¿è¡Œå‹•æ›´æœ‰é­…åŠ›èˆ‡æ„ŸæŸ“åŠ›ã€‚",
  "{zodiacZh}é¢å°æŒ‘æˆ°ä¸æ‡¼ï¼Œã€Œ{firstChar}ã€æ”¶æ–‚è¡å‹•ï¼Œè½‰åŒ–ç‚ºé­…åŠ›èˆ‡é ˜å°åŠ›ã€‚",
  "{zodiacZh}èƒ½é‡ç†±çƒˆè‡ªä¿¡ï¼Œã€Œ{firstChar}ã€æ˜ ç…§æ­¤å…‰ï¼Œæˆå°±å„ªé›…èˆ‡å …æ¯…å…¼å…·çš„ç‰¹è³ªã€‚"
];
function formatTpl(tpl, obj){
  return tpl.replace(/\{(\w+)\}/g, (_,k)=> obj[k] ?? '');
}
function templateIndexBySeed(n){
  const seedStr = makeSeedString() + '|TEMPLATE';
  if ((qs.get('var')||'').toLowerCase()==='random') return Math.floor(Math.random()*n);
  return Math.abs(hash2(seedStr)) % n;
}
const ctx = {
  month: m,
  el, elZh,
  firstChar: cnGiven.charAt(0),
  secondChar: cnGiven.charAt(1) || cnGiven.charAt(0),
  zodiacEn: z,
  zodiacZh: zInfo.cn,
  traitEn: zInfo.traitEn,
  traitZh: zInfo.traitZh
};
const tplIdx = templateIndexBySeed(10);

// === 8) å¯«å› UI ===
const $ = (id)=>document.getElementById(id);
$('enName').textContent   = `English Name: ${enName}`;
$('cnFullName').textContent = cnFull;
$('pinyinFull').textContent = pyFull;

$('tagline').innerHTML =
  `Your exclusive Chinese name is <span class="em zh">${cnFull}</span>. Meaning: <span class="em">${chosen.meaningEn||''}</span>ï½œä½ çš„ä¸­æ–‡åå­—æ˜¯ã€Œ<span class="em zh">${cnFull}</span>ã€ï¼Œæ„æ¶µï¼š<span class="em zh">${chosen.meaningZh||''}</span>`;

const sNoteEn = s.noteEn || ''; const sEra = s.era || ''; const sFEn = s.famousEn || '';
$('surnameLine').textContent = `${cnSurname} (${pySurname}) â€” ${sNoteEn}`;
$('surnameOrigin').innerHTML = `<strong>Origin:</strong> ${sEra} dynasty; famous figure: ${sFEn}`;

$('givenLine').textContent = `${cnGiven} (${pyGiven}) â€” ${chosen.meaningEn||''}`;
$('classicEn').innerHTML =
  `<strong>Classic Source:</strong> The character â€œ${primaryChar}â€ in <em>${sourceEn}</em> â€” â€œ${quoteEn}â€.`;
$('classicZh').innerHTML =
  `<span class="zh"><strong>å…¸ç±å‡ºè™•ï¼š</strong>${sourceZh}â€”â€”ã€Œ${quoteZh}ã€ã€‚</span>`;

$('fiveElEn').innerHTML = `<strong>Five-Element Reading:</strong> ${formatTpl(FE_TEMPLATES_EN[tplIdx], ctx)}`;
$('fiveElZh').innerHTML = `<span class="zh"><strong>äº”è¡Œè§£è®€ï¼š</strong>${formatTpl(FE_TEMPLATES_ZH[tplIdx], ctx)}</span>`;
$('zodiacEn').innerHTML = `<strong>Zodiac:</strong> ${formatTpl(ZO_TEMPLATES_EN[tplIdx], ctx)}`;
$('zodiacZh').innerHTML = `<span class="zh"><strong>æ˜Ÿè±¡ï¼š</strong>${formatTpl(ZO_TEMPLATES_ZH[tplIdx], ctx)}</span>`;

// === 9) å®Œæˆ â†’ æ·¡å‡º overlay ===
try { clearInterval(floatTimer); } catch(e){}
if (overlay) {
  overlay.classList.add('hide');
  setTimeout(()=> overlay.remove(), 900);
    // TTS
    function speak(text){
      const u = new SpeechSynthesisUtterance(text);
      const v = speechSynthesis.getVoices().find(v=>/zh|cmn|Chinese/i.test(v.lang));
      if(v) u.voice=v; u.lang=v?.lang||'zh-TW'; u.rate=.96; u.pitch=1.04; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
    $('speak').addEventListener('click', ()=> speak(cnFull));
    if (speechSynthesis && typeof speechSynthesis.onvoiceschanged !== 'undefined') {
      speechSynthesis.onvoiceschanged = ()=>{};
    }

    // Download PDF
    $('download').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const node = document.querySelector('#cert');
      const canvas = await html2canvas(node, {scale:2});
      const img = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p','pt','a4');
      const pageW = pdf.internal.pageSize.getWidth();
      const ratio = pageW / canvas.width; const h = canvas.height * ratio;
      pdf.addImage(img,'PNG',0,10,pageW,h);
      pdf.save(`HanName_${cnFull}.pdf`);
    });

    // Share
    $('share').addEventListener('click', async ()=>{
      const url = location.href;
      const text = `My Chinese name on HanName: ${cnFull} (${pyFull}).`;
      if(navigator.share){ try{ await navigator.share({title:'HanName Certificate', text, url}); }catch(e){} }
      else{ await navigator.clipboard.writeText(url); alert('Link copied!'); }
    });
  })();
  </script>
</body>
</html> 