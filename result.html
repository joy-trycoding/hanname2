<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HanName â€” Your Chinese Name Certificate</title>
  <meta name="description" content="A bilingual, culturally-rich Chinese name certificate with pronunciation, literature sources, five-element analysis, and zodiac insights." />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Noto+Serif+TC:wght@400;500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <base href="https://joy-trycoding.github.io/hanname2/">

  <style>
/* ===== Loading overlay ===== */
.loading-overlay{
  position: fixed; inset: 0; background: rgba(245,241,232,0.9);
  display:flex; align-items:center; justify-content:center;
  z-index:9999; transition: opacity .6s ease, visibility .6s ease;
  overflow:hidden;
}
.loading-overlay.hide{ opacity:0; visibility:hidden; }
.loading-msg{
  position: relative; z-index:2;
  font-family:'Noto Serif TC','Playfair Display',serif;
  font-size:22px; color:#444; letter-spacing:.06em;
  background: rgba(255,255,255,0.6);
  padding:10px 16px; border-radius:8px; border:1px solid #e7e0d2;
  box-shadow: 0 6px 30px rgba(0,0,0,.05);
}
.floating-zh{ position:absolute; inset:0; overflow:hidden; z-index:1; pointer-events:none; }
.floating-zh span{
  position:absolute; font-family:'Noto Serif TC','Playfair Display',serif;
  font-size: clamp(18px, 3vw, 32px); color:#000; opacity:.06; white-space:nowrap; user-select:none;
  animation: floatUp 6s linear infinite;
}
@keyframes floatUp{
  0%{ transform: translateY(20px); opacity:0.02; }
  10%{ opacity:.08; }
  90%{ opacity:.08; }
  100%{ transform: translateY(-40px); opacity:0; }
}

/* ===== Theme & layout ===== */
:root{ --paper:#F5F1E8; --ink:#1C1B1A; --accent:#C49A6C; --muted:#666; --line:#E5DFD3; }
*{box-sizing:border-box}
body{margin:0; background:var(--paper); color:var(--ink); font-family:'Inter','Noto Serif TC',serif; line-height:1.65}
a{color:inherit}
.header{display:flex; align-items:center; gap:10px; padding:10px 16px}
.header .brand img{height:32px}
.wrap{max-width:980px; margin:0 auto; padding:16px}

/* Certificate card */
.certificate{background:#fff; border:8px double var(--line); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.06); padding:24px;}
.title{font-family:'Playfair Display','Noto Serif TC',serif; text-align:center; font-size:28px; margin:6px 0 2px}
.subtitle{text-align:center; color:#444; font-size:13px; margin:0 0 10px}
.divider{height:2px; background:var(--line); margin:12px 0 18px}

/* Name block */
.name-block{display:grid; gap:4px; justify-items:center; margin:8px 0 16px}
.cn-name{font-family:'Noto Serif TC','Playfair Display',serif; font-size:46px; font-weight:700; letter-spacing:.06em}
.pinyin{font-size:16px; color:var(--accent)}
.btn{appearance:none; border:1px solid var(--ink); background:var(--ink); color:#fff; padding:8px 14px; border-radius:999px; cursor:pointer}
.btn:hover{opacity:.92}
.btn-ghost{background:#fff; color:var(--ink); border:1px solid var(--ink)}

/* Info grid */
.grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
.panel{border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff}
.panel h3{font-family:'Playfair Display','Noto Serif TC',serif; font-size:18px; margin:0 0 8px}
.panel p{margin:6px 0}
.em{color:#222; font-weight:600}
.zh{font-family:'Noto Serif TC','Playfair Display',serif}

/* Story block */
.story{margin-top:10px; padding-top:10px; border-top:1px dashed var(--line)}
.story h4{margin:0 0 6px; font-size:15px; color:#333}
.story p{margin:6px 0}

/* Actions */
.actions{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px}
.share-wrap{position:relative; display:inline-flex}
.share-pop{position:absolute; top:calc(100% + 8px); right:0; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:8px; display:none; min-width:220px; z-index:50}
.share-pop.open{display:block}
.share-pop .row{display:flex; gap:8px; flex-wrap:wrap; padding:6px}
.share-pop .hint{font-size:12px; color:#555; padding:6px 8px 2px}

/* Gift gallery */
.gifts{margin-top:22px}
.gifts h3{font-family:'Playfair Display','Noto Serif TC',serif; font-size:20px; margin:6px 0 10px; text-align:center}
.gift-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
.gift{background:#fff; border:1px solid var(--line); border-radius:14px; overflow:hidden; display:flex; flex-direction:column}
.gift img{width:100%; height:auto; display:block}
.gift-body{padding:12px}
.gift h4{margin:0 0 6px; font-size:16px}
.gift p{margin:0 0 10px; color:#333; font-size:14px}
.gift .row{display:flex; gap:8px; flex-wrap:wrap}

/* Footer note */
.footnote{margin-top:12px; font-size:12px; color:#666; text-align:center}

/* RWD */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
  .cn-name{font-size:40px}
  .gift-grid{grid-template-columns:1fr}
}
  </style>
</head>
<body>
  <header class="header">
    <a class="brand" href="index.html" aria-label="Back to HanName home">
      <img src="assets/logo.jpg" alt="HanName logo" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'HanName',style:'font-weight:700;font-family:Playfair Display, Noto Serif TC, serif;font-size:18px;' }))" />
    </a>
  </header>

  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <!-- â‘  è‹±æ–‡åŒ– -->
    <div class="loading-msg">Designing your nameâ€¦</div>
    <div id="floatingZh" class="floating-zh"></div>
  </div>

  <main class="wrap">
    <section id="cert" class="certificate">
      <h1 class="title">Chinese Name Certificate</h1>
      <p class="subtitle">A personalized cultural identity crafted from sound, meaning, literature, Five Elements, and zodiac.</p>
      <div class="divider"></div>

      <div class="name-block">
        <div id="enName" class="en-name" style="font-size:14px; color:#555">English Name: â€”</div>
        <div id="cnFullName" class="cn-name">â€”</div>
        <div class="pinyin"><span id="pinyinFull">â€”</span> <button id="speak" class="btn" data-track="play-tts" title="Hear pronunciation">ğŸ”Š</button></div>
        <div id="tagline" style="font-size:14px; color:#333"></div>
      </div>

      <div class="grid">
        <article class="panel" id="surnamePanel">
          <h3>Surname Â· å§“æ°</h3>
          <p id="surnameLine"></p>
          <p id="surnameOrigin"></p>
        </article>

        <article class="panel" id="givenPanel">
          <h3>Given Name Â· åå­—</h3>
          <p id="givenLine"></p>

          <!-- Cultural story -->
          <div class="story">
            <h4>Story Â· åå­—çš„æ•…äº‹</h4>
            <p id="storyEn"></p>
            <p id="storyZh" class="zh"></p>
          </div>

          <div class="analysis">
            <p id="classicEn"></p>
            <p id="classicZh" class="zh"></p>
            <p id="fiveElEn"></p>
            <p id="fiveElZh" class="zh"></p>
            <p id="zodiacEn"></p>
            <p id="zodiacZh" class="zh"></p>
          </div>
        </article>
      </div>

      <!-- Actions -->
      <div class="actions" aria-label="actions">
        <button id="download" class="btn" data-track="download-cert">Download Certificate</button>
        <a id="gift" class="btn btn-ghost" href="gift.html" data-track="seal-gift">Create Your Seal Gift</a>

        <!-- â‘¡ å–®ä¸€ Share æŒ‰éˆ• + Popover é¸æ“‡ -->
        <div class="share-wrap">
          <button id="shareMain" class="btn" title="Share your name">Share</button>
          <div id="sharePop" class="share-pop" role="menu" aria-hidden="true">
            <div class="hint">Choose a platform</div>
            <div class="row">
              <button id="shareX" class="btn">X (Twitter)</button>
              <button id="shareThreads" class="btn btn-ghost">Threads</button>
              <button id="shareIG" class="btn btn-ghost">Instagram</button>
            </div>
          </div>
        </div>
      </div>

      <p class="footnote">Tip: Save this certificate as a PDF or print it.</p>

      <!-- â‘¢ Gifts: è‹±æ–‡æ¨™é¡Œ/èªªæ˜ + åœ–ç‰‡ + è‹±æ–‡æŒ‰éˆ• -->
      <div class="gifts" id="giftShowcase">
        <h3>Bring Your Name to Life</h3>
        <div class="gift-grid">
          <article class="gift">
            <img src="assets/gifts/calligraphy-scroll.jpg" alt="Handwritten calligraphy scroll by respected elder" loading="lazy" onerror="this.src='assets/gifts/wood-seal.jpg'">
            <div class="gift-body">
              <h4>Elderâ€™s Handwritten Calligraphy Scroll</h4>
              <p>Your Chinese name is handwritten with a brush by a respected elder â€” a keepsake carrying blessings and care.</p>
              <div class="row">
                <a class="btn btn-ghost" href="gift.html#handwritten">Learn more</a>
                <a class="btn" href="gift.html#handwritten">Shop now</a>
              </div>
            </div>
          </article>

          <article class="gift">
            <img src="assets/gifts/wood-seal.jpg" alt="Custom wooden or horn name seal" loading="lazy">
            <div class="gift-body">
              <h4>Custom Name Seal (Wood or Horn)</h4>
              <p>Engraved with your name â€” optionally with a classical source â€” practical, meaningful, and beautifully traditional.</p>
              <div class="row">
                <a class="btn btn-ghost" href="gift.html#seal">Learn more</a>
                <a class="btn" href="gift.html#seal">Shop now</a>
              </div>
            </div>
          </article>

          <article class="gift">
            <img src="assets/gifts/gift-box.jpg" alt="Premium gift box with certificate and seal" loading="lazy" onerror="this.src='assets/gifts/horn-seal.jpg'">
            <div class="gift-body">
              <h4>Premium Gift Box (Certificate + Seal)</h4>
              <p>A complete set that pairs your bilingual certificate with a custom seal and story card â€” perfect for gifting.</p>
              <div class="row">
                <a class="btn btn-ghost" href="gift.html#box">Learn more</a>
                <a class="btn" href="gift.html#box">Shop now</a>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    (async function init(){
      /* ===== Config & helpers ===== */
      const ROOT = "/hanname2";
      const PATH = {
        surnames: `${ROOT}/data/surnames.json?v=fix2`,
        classics: `${ROOT}/data/classics.json?v=fix2`,
        // å¯æ—¥å¾Œæ–°å¢ï¼šgivens: `${ROOT}/data/givenNameData.json?v=fix2`
      };
    
      const $ = (id)=>document.getElementById(id);
      const hash2 = (s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h|0; };
      const pickIndex = (n, seedStr)=> (n? Math.abs(hash2(seedStr))%n : -1);
      async function loadJSON(url){ const res=await fetch(url,{cache:"no-store"}); if(!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); }
    
      /* ===== Five elements & zodiac ===== */
      const MONTH_TO_ELEMENT = {1:'Water',2:'Wood',3:'Wood',4:'Wood',5:'Fire',6:'Fire',7:'Fire',8:'Earth',9:'Metal',10:'Metal',11:'Water',12:'Water'};
      const ELEMENT_ZH = {Wood:'æœ¨', Fire:'ç«', Earth:'åœŸ', Metal:'é‡‘', Water:'æ°´'};
      function zodiac(m,d){
        const z=[['Capricorn',1,19],['Aquarius',2,18],['Pisces',3,20],['Aries',4,19],['Taurus',5,20],['Gemini',6,20],['Cancer',7,22],['Leo',8,22],['Virgo',9,22],['Libra',10,22],['Scorpio',11,21],['Sagittarius',12,21],['Capricorn',12,31]];
        for(const [name,mm,dd] of z){ if(m<mm || (m===mm && d<=dd)) return name; }
      }
      const ZODIAC_CN_MAP = {
        Pisces:{cn:'é›™é­š', traitEn:'sensitive and insightful', traitZh:'æ„Ÿæ€§è€Œå…·æ´å¯ŸåŠ›'},
        Aries:{cn:'ç‰¡ç¾Š', traitEn:'decisive and pioneering', traitZh:'æœæ•¢é–‹å‰µ'},
        Taurus:{cn:'é‡‘ç‰›', traitEn:'grounded and persevering', traitZh:'è¸å¯¦å …å®š'},
        Gemini:{cn:'é›™å­', traitEn:'curious and expressive', traitZh:'å¥½å¥‡å–„è¨€'},
        Cancer:{cn:'å·¨èŸ¹', traitEn:'nurturing and protective', traitZh:'é—œæ‡·å®ˆè­·'},
        Leo:{cn:'ç…å­', traitEn:'radiant and confident', traitZh:'è‡ªä¿¡é–ƒè€€'},
        Virgo:{cn:'è™•å¥³', traitEn:'refined and meticulous', traitZh:'ç´°è†©è¬›ç©¶'},
        Libra:{cn:'å¤©ç§¤', traitEn:'balanced and graceful', traitZh:'å¹³è¡¡å„ªé›…'},
        Scorpio:{cn:'å¤©è ', traitEn:'deep and resolute', traitZh:'æ·±æ²‰æœæ±º'},
        Sagittarius:{cn:'å°„æ‰‹', traitEn:'far-sighted and free', traitZh:'é å¿—è‡ªç”±'},
        Capricorn:{cn:'æ‘©ç¾¯', traitEn:'enduring and disciplined', traitZh:'éŸŒæ€§è‡ªå¾‹'},
        Aquarius:{cn:'æ°´ç“¶', traitEn:'original and humane', traitZh:'å‰µæ–°åšæ„›'}
      };
    
      /* ===== Minimal given-name fallback pool ===== */
      const FALLBACK_POOL = {
        Wood:{
          female:[{cn:'é›…å¯§',py:'YÇnÃ­ng',gender:'female',classicChar:'é›…',classicSourceEn:'Shijing Â· Da Ya',classicSourceZh:'ã€Šè©©ç¶“Â·å¤§é›…ã€‹',quoteEn:'Da Ya',quoteZh:'å¤§é›…',meaningEn:'elegance & serenity',meaningZh:'å„ªé›…èˆ‡å®‰å¯§'}],
          male:[{cn:'åšé ',py:'BÃ³yuÇn',gender:'male',classicChar:'é ',classicSourceEn:'Qu Yuan Â· Lisao',classicSourceZh:'å±ˆåŸÂ·é›¢é¨·',quoteEn:'The road ahead is long',quoteZh:'è·¯æ¼«æ¼«å…¶ä¿®é å…®',meaningEn:'breadth and vision',meaningZh:'èƒ¸è¥Ÿèˆ‡å®é '}],
          neutral:[{cn:'æ¸…é›²',py:'QÄ«ngyÃºn',gender:'neutral',classicChar:'é›²',classicSourceEn:'Tang Poetry imagery',classicSourceZh:'å”è©©æ„è±¡',quoteEn:'Clouds travel free',quoteZh:'é›²ç„¡å¿ƒä»¥å‡ºå²«',meaningEn:'clarity and freedom',meaningZh:'æ¸…æ¾ˆè‡ªç”±'}]
        },
        Fire:{
          female:[{cn:'æ›‰æ©',py:'XiÇoÄ“n',gender:'female',classicChar:'æ›‰',classicSourceEn:'Song Ci',classicSourceZh:'å®‹è©',quoteEn:'Dawn breeze and waning moon',quoteZh:'æ›‰é¢¨æ®˜æœˆ',meaningEn:'gentle warmth',meaningZh:'æº«æŸ”æ™¨å…‰'}],
          male:[{cn:'æ–‡è»’',py:'WÃ©nxuÄn',gender:'male',classicChar:'æ–‡',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteEn:'Be never weary of learning',quoteZh:'å­¸è€Œä¸å­',meaningEn:'cultured and bright',meaningZh:'æ–‡é›…æ˜æœ—'}],
          neutral:[{cn:'æ›œå’Œ',py:'YÃ ohÃ©',gender:'neutral',classicChar:'æ›œ',classicSourceEn:'Shijing imagery',classicSourceZh:'ã€Šè©©ç¶“ã€‹æ„è±¡',quoteEn:'Radiant light',quoteZh:'å…‰æ›œå…¶è¯',meaningEn:'radiant & harmonious',meaningZh:'æ˜éº—è€Œä¸­å’Œ'}]
        },
        Earth:{
          female:[{cn:'éœç‘¤',py:'JÃ¬ngyÃ¡o',gender:'female',classicChar:'ç‘¤',classicSourceEn:'Tang poetry',classicSourceZh:'å”è©©',quoteEn:'Jade terrace and moon',quoteZh:'ç‘¤å°æœˆä¸‹',meaningEn:'quiet radiance',meaningZh:'éœä¸­ç”Ÿå…‰'}],
          male:[{cn:'å¿—å®',py:'ZhÃ¬hÃ³ng',gender:'male',classicChar:'å¿—',classicSourceEn:'Mencius',classicSourceZh:'ã€Šå­Ÿå­ã€‹',quoteEn:'Will on the Way',quoteZh:'å¿—æ–¼é“ï¼Œæ“šæ–¼å¾·',meaningEn:'great aspiration',meaningZh:'å®é ä¹‹å¿—'}],
          neutral:[{cn:'è¡¡é€¸',py:'HÃ©ngyÃ¬',gender:'neutral',classicChar:'è¡¡',classicSourceEn:'Doctrine of the Mean',classicSourceZh:'ã€Šä¸­åº¸ã€‹',quoteEn:'Holding the balance',quoteZh:'åŸ·å…¶ä¸­',meaningEn:'balance & ease',meaningZh:'ä¸­å’Œèˆ‡ç‘è„«'}]
        },
        Metal:{
          female:[{cn:'æ™¯è¨€',py:'JÇngyÃ¡n',gender:'female',classicChar:'è¨€',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteEn:'Words reflect the heart',quoteZh:'è¨€ç‚ºå¿ƒè²',meaningEn:'clear expression',meaningZh:'æ¸…æœ—ä¹‹è¨€'}],
          male:[{cn:'å®‡è¾°',py:'YÇ”chÃ©n',gender:'male',classicChar:'è¾°',classicSourceEn:'Song Ci',classicSourceZh:'å®‹è©',quoteEn:'Fine time & scene',quoteZh:'è‰¯è¾°ç¾æ™¯',meaningEn:'cosmic poise',meaningZh:'å®‡é‡èˆ‡æ™‚è¾°'}],
          neutral:[{cn:'æ­£ç„¶',py:'ZhÃ¨ngrÃ¡n',gender:'neutral',classicChar:'æ­£',classicSourceEn:'Great Learning',classicSourceZh:'ã€Šå¤§å­¸ã€‹',quoteEn:'Rectify the mind',quoteZh:'æ­£å¿ƒèª æ„',meaningEn:'upright & natural',meaningZh:'ç«¯æ­£è‡ªç„¶'}]
        },
        Water:{
          female:[{cn:'å¿ƒå¦‚',py:'XÄ«nrÃº',gender:'female',classicChar:'å¿ƒ',classicSourceEn:'Literary aphorism',classicSourceZh:'æ–‡äººèª',quoteEn:'Heart like water',quoteZh:'ä¸€å¿ƒå¦‚æ°´',meaningEn:'pure-hearted',meaningZh:'å¿ƒæ¾„å¦‚æ°´'}],
          male:[{cn:'æ¸…æŸ',py:'QÄ«ngbÇi',gender:'male',classicChar:'æŸ',classicSourceEn:'Analects',classicSourceZh:'ã€Šè«–èªã€‹',quoteEn:'Pine & cypress endure',quoteZh:'æ­²å¯’ç„¶å¾ŒçŸ¥æ¾æŸä¹‹å¾Œå‡‹ä¹Ÿ',meaningEn:'clarity & integrity',meaningZh:'æ¸…æ­£èˆ‡ç¯€æ“'}],
          neutral:[{cn:'æ¶µç†™',py:'HÃ¡nxÄ«',gender:'neutral',classicChar:'æ¶µ',classicSourceEn:'Wenxin Diaolong',classicSourceZh:'ã€Šæ–‡å¿ƒé›•é¾ã€‹',quoteEn:'Immerse in patterns',quoteZh:'æ¶µæ³³æ–‡ç†',meaningEn:'inclusive & warm',meaningZh:'åŒ…æ¶µæº«å’Œ'}]
        }
      };
    
      /* ===== Query & demo ===== */
      const qs = new URLSearchParams(location.search);
      let enName = (qs.get('name') || '').trim();
      let gender = (qs.get('gender') || '').toLowerCase();
      const birth = qs.get('birth') || '';
    
      const DEMO = [
        {en:'Emily Smith', gender:'female', birth:'1994-03-02'},
        {en:'Daniel Lee', gender:'male',   birth:'1992-07-15'},
        {en:'Sophia Chen', gender:'female',birth:'1996-06-28'}
      ];
      if(!enName){
        const demo = DEMO[Math.floor(Math.random()*DEMO.length)];
        enName = demo.en;
        if(!qs.get('gender')) gender = demo.gender;
        if(!qs.get('birth')){
          location.search = `?name=${encodeURIComponent(enName)}&gender=${demo.gender}&birth=${demo.birth}`;
          return;
        }
      }
    
      // è‹¥æœªæä¾›æ€§åˆ¥ â†’ éš¨æ©Ÿç”·/å¥³
      if(!gender){ gender = (Math.random()<0.5 ? 'male' : 'female'); }
    
      // è§£æè‹±æ–‡å§“ï¼ˆä¿®æ­£ç‚º /\s+/ï¼‰
      const parts = enName.split(/\s+/).filter(Boolean);
      const lastEn = (parts.length>1 ? parts.at(-1) : parts[0]||'').toLowerCase();
    
      /* ===== Load data ===== */
      let SURNAME_CATALOG = [];
      let CLASSICS = [];
      try{
        SURNAME_CATALOG = await loadJSON(PATH.surnames);
      }catch(e){
        SURNAME_CATALOG = [{cn:'æ—', py:'LÃ­n', aliases:['lin'], noteEn:'From forest; harmony with nature.', era:'Zhou', famousEn:'Lin Bu â€” Song poet'}];
      }
      try{
        CLASSICS = await loadJSON(PATH.classics);
      }catch(e){ CLASSICS = []; }
    
      /* ===== Surname mapping ===== */
      function mapEnglishToSurname(last){
        const key = (last||'').toLowerCase().replace(/[^a-z]/g,'');
        if(!key) return SURNAME_CATALOG.find(s=>s.cn==='æ—') || SURNAME_CATALOG[0];
        for(const s of SURNAME_CATALOG){
          if(s.aliases && s.aliases.map(a=>a.toLowerCase()).includes(key)) return s;
        }
        // fuzzy
        const iv = key[0] + key.replace(/[bcdfghjklmnpqrstvwxyz]/g,'');
        let best=null, score=-1;
        for(const s of SURNAME_CATALOG){
          const a = (s.aliases && s.aliases[0]) || ((s.py||'')+'').toLowerCase();
          if(!a) continue;
          const iv2 = a[0] + a.replace(/[^aeiou]/g,'');
          let sc = 0; if(a[0]===key[0]) sc+=2; if(iv===iv2) sc+=2; if(a.includes(key.slice(0,2))) sc+=1;
          if(sc>score){score=sc; best=s;}
        }
        return best || SURNAME_CATALOG[0];
      }
      const s = mapEnglishToSurname(lastEn);
      const cnSurname = s.cn;
      const pySurname = s.py || '';
    
      /* ===== Time, element, zodiac ===== */
      let m=1,d=1;
      if(birth){ const dt=new Date(birth); if(!isNaN(dt)) { m=dt.getMonth()+1; d=dt.getDate(); } }
      const el = MONTH_TO_ELEMENT[m] || 'Wood';
      const elZh = ELEMENT_ZH[el] || 'æœ¨';
      const z = zodiac(m,d) || 'Pisces';
      const zInfo = ZODIAC_CN_MAP[z] || ZODIAC_CN_MAP['Pisces'];
    
      /* ===== Given-name selection with strict gender ===== */
      function pickGivenByPool(element, genderStr){
        const pool = FALLBACK_POOL[element] || FALLBACK_POOL.Wood;
        const genderKey = (genderStr.startsWith('f')?'female': (genderStr.startsWith('m')?'male':'neutral'));
        const candidates = [
          ...(pool[genderKey]||[]),
          ...(pool.neutral||[]),
          ...(genderKey!=='female' ? (pool.female||[]) : []),
          ...(genderKey!=='male'   ? (pool.male||[])   : [])
        ];
        const seedStr = [enName.toLowerCase(), birth, genderKey, cnSurname, el, z, d].join('|');
        const idx = pickIndex(candidates.length, seedStr);
        return candidates[idx>=0?idx:0] || pool.neutral?.[0] || pool.female?.[0] || pool.male?.[0];
      }
      const chosen = pickGivenByPool(el, gender);
    
      const cnGiven = chosen.cn;
      const pyGiven  = chosen.py;
      const cnFull = cnSurname + cnGiven;
      const pyFull = `${pySurname} ${pyGiven}`.trim();
    
      /* ===== Classic lookup (optional enrich) ===== */
      function findClassic(char){
        if(!char || !CLASSICS.length) return {};
        return CLASSICS.find(c=>c.char===char) || {};
      }
      const primaryChar = chosen.classicChar || cnGiven.charAt(0);
      const classic = findClassic(primaryChar);
      const sourceEn = classic.sourceEn || chosen.classicSourceEn || '';
      const sourceZh = classic.sourceZh || chosen.classicSourceZh || '';
      const quoteEn  = classic.quoteEn  || chosen.quoteEn  || '';
      const quoteZh  = classic.quoteZh  || chosen.quoteZh  || '';
    
      /* ===== Explanations templates ===== */
      const FE_EN = [
        "Born in month {month}, your nature aligns with {el} ({elZh}). The first character â€œ{firstChar}â€ steadies emotions and nourishes growth.",
        "The element {el} ({elZh}) colors your temperament with empathy and creativity; â€œ{firstChar}â€ provides balance and inner poise.",
        "With {elZh} energy, youâ€™re adaptive and compassionate. â€œ{firstChar}â€ anchors this flow, turning inspiration into gentle strength."
      ];
      const FE_ZH = [
        "ç”Ÿæ–¼{month}æœˆï¼Œäº”è¡Œå{elZh}ã€‚ã€Œ{firstChar}ã€ä½¿æ°£è³ªæ›´ç©©ï¼Œæº«æ½¤è€Œæœ‰å®šåŠ›ã€‚",
        "{elZh}ä¹‹æ€§è³¦äºˆéˆæ€§èˆ‡åŒç†ï¼Œã€Œ{firstChar}ã€èª¿å’Œå…¶é–“ï¼Œä½¿å¿ƒå¢ƒå¹³è¡¡ã€‚",
        "å‘½æ ¼è¦‹{elZh}ï¼Œå–„æ‡‰è®Šä¸”å…·åŒ…å®¹ï¼Œã€Œ{firstChar}ã€å¦‚æ ¹ï¼Œä»¤éˆæ„ŸåŒ–ç‚ºè¸å¯¦åŠ›é‡ã€‚"
      ];
      const ZO_EN = [
        "As a {zodiacEn} ({zodiacZh}), you carry {traitEn}. The second character â€œ{secondChar}â€ refines this spark into graceful presence.",
        "{zodiacEn} spirits are vivid; â€œ{secondChar}â€ helps express courage with clarity and kindness.",
        "Under {zodiacEn}, â€œ{secondChar}â€ channels drive into charm, shaping influence that feels authentic."
      ];
      const ZO_ZH = [
        "å±¬æ–¼{zodiacZh}ï¼Œä½ å…·{traitZh}ï¼›ç¬¬äºŒå­—ã€Œ{secondChar}ã€æ”¶æ–‚éŠ³æ°£ï¼ŒåŒ–ç‚ºå¾å®¹é¢¨åº¦ã€‚",
        "{zodiacZh}å€‹æ€§é®®æ˜ï¼Œã€Œ{secondChar}ã€åŠ©ä½ ä»¥æ¸…æ™°èˆ‡å–„æ„è¡¨é”å‹‡æ°£ã€‚",
        "åœ¨{zodiacZh}ä¹‹ä¸‹ï¼Œã€Œ{secondChar}ã€å°å¼•å‹•èƒ½æˆç‚ºé­…åŠ›ï¼Œä½¿å½±éŸ¿åŠ›æ›´çœŸèª ã€‚"
      ];
      function fmt(tpl, ctx){ return tpl.replace(/\{(\w+)\}/g,(_,k)=>ctx[k]??''); }
      const ctx = {
        month:m, el, elZh,
        firstChar: cnGiven.charAt(0),
        secondChar: cnGiven.charAt(1)||cnGiven.charAt(0),
        zodiacEn: z, zodiacZh:zInfo.cn,
        traitEn: zInfo.traitEn, traitZh: zInfo.traitZh
      };
      const feIdx = pickIndex(FE_EN.length, enName+'|'+birth+'|FE');
      const zoIdx = pickIndex(ZO_EN.length, enName+'|'+birth+'|ZO');
    
      /* ===== Cultural story ===== */
      function buildStory(){
        const sEN = [
          `Your name ${cnFull} (${pyFull}) weaves tradition and self together: â€œ${cnGiven.charAt(0)}â€ draws on classical imagery (${sourceEn}), while â€œ${cnGiven.charAt(1)||cnGiven.charAt(0)}â€ mirrors your ${z.toLowerCase()} spiritâ€”${zInfo.traitEn}. The surname â€œ${cnSurname}â€ adds lineage and belonging.`,
          `In Chinese, names carry wishes. ${cnFull} speaks of ${chosen.meaningEn||'grace and character'}â€”a keepsake you can voice, write, and even seal.`
        ].join(' ');
        const sZH = [
          `ä½ çš„åå­—ã€Œ${cnFull}ã€èåˆå‚³çµ±èˆ‡è‡ªæˆ‘ï¼šå…¶ä¸€å­—å–æ„æ–¼${sourceZh}ï¼Œå…¶äºŒå­—å‘¼æ‡‰${zInfo.cn}çš„æ°£è³ªï¼ˆ${zInfo.traitZh}ï¼‰ï¼Œã€Œ${cnSurname}ã€æ‰¿è¼‰å®¶æ—èˆ‡æ­¸å±¬ã€‚`,
          `ä¸­æ–‡åæ‰¿è¼‰ç¥é¡˜ã€‚ã€Œ${cnFull}ã€å¯“æ„${chosen.meaningZh||'é¢¨é›…èˆ‡å“æ ¼'}ï¼Œä¸åƒ…èƒ½è¢«æœ—è®€æ›¸å¯«ï¼Œä¹Ÿèƒ½ä»¥å°ç« å…¸è—ã€‚`
        ].join(' ');
        return { en:sEN, zh:sZH };
      }
      const story = buildStory();
    
      /* ===== Write UI ===== */
      $('enName').textContent   = `English Name: ${enName}`;
      $('cnFullName').textContent = cnFull;
      $('pinyinFull').textContent = pyFull;
      $('tagline').innerHTML = `Your exclusive Chinese name is <span class="em zh">${cnFull}</span>. Meaning: <span class="em">${chosen.meaningEn||''}</span>ï½œä½ çš„ä¸­æ–‡åå­—æ˜¯ã€Œ<span class="em zh">${cnFull}</span>ã€ï¼Œæ„æ¶µï¼š<span class="em zh">${chosen.meaningZh||''}</span>`;
    
      const sNoteEn = s.noteEn || ''; const sEra = s.era || ''; const sFEn = s.famousEn || '';
      $('surnameLine').textContent = `${cnSurname} (${pySurname}) â€” ${sNoteEn}`;
      $('surnameOrigin').innerHTML = `<strong>Origin:</strong> ${sEra||'Classical era'}; famous figure: ${sFEn||'â€”'}`;
    
      $('givenLine').textContent = `${cnGiven} (${pyGiven}) â€” ${chosen.meaningEn||''}`;
      $('classicEn').innerHTML = `<strong>Classic Source:</strong> The character â€œ${chosen.classicChar||cnGiven.charAt(0)}â€ in <em>${sourceEn}</em> â€” â€œ${quoteEn}â€.`;
      $('classicZh').innerHTML = `<span class="zh"><strong>å…¸ç±å‡ºè™•ï¼š</strong>${sourceZh}â€”â€”ã€Œ${quoteZh}ã€ã€‚</span>`;
    
      $('fiveElEn').innerHTML = `<strong>Five-Element Reading:</strong> ${fmt(FE_EN[feIdx], ctx)}`;
      $('fiveElZh').innerHTML = `<span class="zh"><strong>äº”è¡Œè§£è®€ï¼š</strong>${fmt(FE_ZH[feIdx], ctx)}</span>`;
      $('zodiacEn').innerHTML = `<strong>Zodiac:</strong> ${fmt(ZO_EN[zoIdx], ctx)}`;
      $('zodiacZh').innerHTML = `<span class="zh"><strong>æ˜Ÿè±¡ï¼š</strong>${fmt(ZO_ZH[zoIdx], ctx)}</span>`;
    
      $('storyEn').textContent = story.en;
      $('storyZh').textContent = story.zh;
    
      /* ===== Loading overlay fade out ===== */
      const overlay = document.getElementById('loadingOverlay');
  try { if(overlay){ overlay.classList.add('hide'); setTimeout(()=>overlay.remove(), 900);} } catch(e){}

  /* ====== TTS ====== */
  function speak(text){
    const u = new SpeechSynthesisUtterance(text);
    const v = speechSynthesis.getVoices().find(v=>/zh|cmn|Chinese/i.test(v.lang));
    if(v) u.voice=v; u.lang=v?.lang||'zh-TW'; u.rate=.96; u.pitch=1.04;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  const speakBtn = $('speak');
  if (speakBtn) speakBtn.addEventListener('click', ()=> {
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
    if(cn) speak(cn);
  });

  /* ====== Download PDF ====== */
  const dl = $('download');
  if (dl) dl.addEventListener('click', async ()=>{
    const { jsPDF } = window.jspdf;
    const node = document.querySelector('#cert');
    const canvas = await html2canvas(node, {scale:2});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p','pt','a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const ratio = pageW / canvas.width; const h = canvas.height * ratio;
    pdf.addImage(img,'PNG',0,10,pageW,h);
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || 'HanName';
    pdf.save(`HanName_${cn}.pdf`);
  });

  /* ====== â‘¡ Share ä¸»æŒ‰éˆ• + Popoverï¼ˆå« Web Share APIï¼‰ ====== */
  const shareBtn = $('shareMain');
  const sharePop = $('sharePop');
  const xBtn = $('shareX');
  const thBtn = $('shareThreads');
  const igBtn = $('shareIG');

  function openXShare(){
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
    const py = document.getElementById('pinyinFull')?.textContent?.trim() || '';
    const url = encodeURIComponent(location.href);
    const text = encodeURIComponent(`My Chinese name: ${cn} (${py}) â€” crafted by HanName`);
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`,'_blank','noopener');
  }
  function copyFor(label){
    const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
    const py = document.getElementById('pinyinFull')?.textContent?.trim() || '';
    const lines = [
      `My Chinese name: ${cn} (${py})`,
      `Meaning: ` + (document.getElementById('givenLine')?.textContent?.split('â€”')[1]?.trim() || ''),
      `#HanName #ChineseName`
    ];
    const txt = lines.filter(Boolean).join('\n');
    navigator.clipboard.writeText(txt).then(()=> alert(`${label} text copied! Paste in your app to post.`));
  }

  if (shareBtn){
    shareBtn.addEventListener('click', async () => {
      // åŸç”Ÿåˆ†äº«ï¼ˆè‹¥æ”¯æ´ï¼Œç›´æ¥èµ°ï¼‰
      const cn = document.getElementById('cnFullName')?.textContent?.trim() || '';
      const py = document.getElementById('pinyinFull')?.textContent?.trim() || '';
      const shareData = {
        title: 'HanName Certificate',
        text: `My Chinese name: ${cn} (${py}) â€” crafted by HanName`,
        url: location.href
      };
      if (navigator.share){
        try { await navigator.share(shareData); return; } catch(e){ /* fallback to popover */ }
      }
      // Fallbackï¼šå±•é–‹ popover
      sharePop?.classList.toggle('open');
      sharePop?.setAttribute('aria-hidden', sharePop.classList.contains('open') ? 'false' : 'true');
    });
    // é»å¤–é¢é—œé–‰
    document.addEventListener('click', (e)=>{
      if (!sharePop?.classList.contains('open')) return;
      const within = e.composedPath().includes(shareBtn) || e.composedPath().includes(sharePop);
      if (!within) { sharePop.classList.remove('open'); sharePop.setAttribute('aria-hidden','true'); }
    });
  }
  xBtn && xBtn.addEventListener('click', openXShare);
  thBtn && thBtn.addEventListener('click', ()=>copyFor('Threads'));
  igBtn && igBtn.addEventListener('click', ()=>copyFor('Instagram'));
})();
  </script>

  <!-- Floating zh animation (unchanged) -->
  <script>
(function(){
  const floatBox = document.getElementById('floatingZh');
  if(!floatBox) return;
  function spawn(){
    floatBox.innerHTML = '';
    const words = ['ä½ çš„åå­—','æ­£åœ¨','è¨­è¨ˆä¸­','å„ªé›…','å¹³è¡¡','éˆæ„Ÿ','æ–‡åŒ–','å…¸é›…','è©©æ„','å’Œé³´'];
    const W = window.innerWidth, H = window.innerHeight;
    const N = 16;
    for(let i=0;i<N;i++){
      const span = document.createElement('span');
      span.textContent = words[i % words.length];
      const x = Math.random() * (W - 80);
      const y = Math.random() * (H - 40);
      const delay = (Math.random() * 2).toFixed(2);
      const dur = (5 + Math.random() * 4).toFixed(2);
      span.style.left = `${x}px`;
      span.style.top  = `${y}px`;
      span.style.animationDuration = `${dur}s`;
      span.style.animationDelay = `${delay}s`;
      floatBox.appendChild(span);
    }
  }
  spawn();
  setInterval(spawn, 2800);
})();
  </script>
</body>
</html>